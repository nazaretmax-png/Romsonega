<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>GBA Translator Pro - Selective Edition</title>
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --accent: #38bdf8; --text: #f1f5f9; --success: #22c55e; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); max-width: 1000px; margin: 0 auto; padding: 20px; }
        .card { background: var(--card); padding: 20px; border-radius: 12px; border: 1px solid #334155; margin-bottom: 20px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        h1 { color: var(--accent); text-align: center; font-size: 2em; text-transform: uppercase; letter-spacing: 2px; }
        
        .filter-group { background: #0f172a; padding: 15px; border-radius: 8px; margin: 10px 0; border: 1px solid #334155; }
        label { display: block; margin: 8px 0; cursor: pointer; font-size: 14px; }
        input[type="checkbox"] { margin-right: 10px; transform: scale(1.2); }
        
        button { background: var(--accent); color: #000; border: none; padding: 12px; border-radius: 6px; font-weight: bold; cursor: pointer; width: 100%; transition: 0.3s; }
        button:hover { opacity: 0.8; transform: translateY(-2px); }
        .btn-import { background: var(--success); color: white; }
        
        .log { background: #000; color: #00ff00; font-family: monospace; padding: 15px; height: 150px; overflow-y: auto; border-radius: 8px; font-size: 12px; border: 1px solid #334155; }
        .warning-text { color: #fbbf24; font-size: 12px; margin-top: 5px; }
    </style>
</head>
<body>

    <h1>GBA Translator Pro üéÆ</h1>

    <div class="card">
        <h3>1. Carica la ROM (.gba)</h3>
        <input type="file" id="romFile" accept=".gba">
    </div>

    <div class="grid">
        <div class="card">
            <h3>2. Esporta per Categoria</h3>
            <div class="filter-group">
                <label><input type="checkbox" id="checkMoves" checked> ‚öîÔ∏è Mosse (es. Ember, Tackle)</label>
                <label><input type="checkbox" id="checkItems" checked> üéí Oggetti (es. Potion, Pok√©ball)</label>
                <label><input type="checkbox" id="checkDialogs" checked> üí¨ Dialoghi e Script (Frasi lunghe)</label>
            </div>
            <button onclick="exportText()">Genera TXT da Tradurre</button>
            <p class="warning-text">Verranno filtrate solo le sezioni selezionate.</p>
        </div>

        <div class="card">
            <h3>3. Importa e Patch</h3>
            <p>Carica il file TXT dopo averlo tradotto.</p>
            <input type="file" id="importFile" accept=".txt">
            <button class="btn-import" onclick="importText()">Applica Patch e Salva ROM</button>
        </div>
    </div>

    <div class="card">
        <h3>Console di Sistema</h3>
        <div id="log" class="log">Pronto...</div>
    </div>

    <script>
        const charMap = { 0x00: ' ', 0x01: '√Ä', 0x02: '√Å', 0x03: '√Ç', 0x04: '√á', 0x05: '√à', 0x06: '√â', 0x07: '√ä', 0x08: '√ã', 0x09: '√å', 0x0B: '√é', 0x0C: '√è', 0x0D: '√í', 0x0E: '√ì', 0x0F: '√î', 0x10: '≈í', 0x11: '√ô', 0x12: '√ö', 0x13: '√õ', 0x14: '≈∏', 0x15: '√ü', 0x16: '√†', 0x17: '√°', 0x19: '√ß', 0x1A: '√®', 0x1B: '√©', 0x1C: '√™', 0x1D: '√´', 0x1E: '√¨', 0x20: '√Æ', 0x21: '√Ø', 0x22: '√≤', 0x23: '√≥', 0x24: '√¥', 0x25: '≈ì', 0x26: '√π', 0x27: '√∫', 0x28: '√ª', 0x29: '√ø', 0x2D: '&', 0x2E: '+', 0xAB: '!', 0xAC: '?', 0xAD: '.', 0xAE: '-', 0xB0: '...', 0xB8: ',', 0xBB: 'A', 0xBC: 'B', 0xBD: 'C', 0xBE: 'D', 0xBF: 'E', 0xC0: 'F', 0xC1: 'G', 0xC2: 'H', 0xC3: 'I', 0xC4: 'J', 0xC5: 'K', 0xC6: 'L', 0xC7: 'M', 0xC8: 'N', 0xC9: 'O', 0xCA: 'P', 0xCB: 'Q', 0xCC: 'R', 0xCD: 'S', 0xCE: 'T', 0xCF: 'U', 0xD0: 'V', 0xD1: 'W', 0xD2: 'X', 0xD3: 'Y', 0xD4: 'Z', 0xD5: 'a', 0xD6: 'b', 0xD7: 'c', 0xD8: 'd', 0xD9: 'e', 0xDA: 'f', 0xDB: 'g', 0xDC: 'h', 0xDD: 'i', 0xDE: 'j', 0xDF: 'k', 0xE0: 'l', 0xE1: 'm', 0xE2: 'n', 0xE3: 'o', 0xE4: 'p', 0xE5: 'q', 0xE6: 'r', 0xE7: 's', 0xE8: 't', 0xE9: 'u', 0xEA: 'v', 0xEB: 'w', 0xEC: 'x', 0xED: 'y', 0xEE: 'z', 0xFE: '\n', 0xFF: '[END]' };
        const invMap = Object.fromEntries(Object.entries(charMap).map(([k, v]) => [v, parseInt(k)]));
        
        let romBuffer = null;

        document.getElementById('romFile').onchange = function(e) {
            const reader = new FileReader();
            reader.onload = () => { romBuffer = new Uint8Array(reader.result); log("ROM Caricata con successo."); };
            reader.readAsArrayBuffer(this.files[0]);
        };

        function log(msg) { const l = document.getElementById('log'); l.innerHTML += `> ${msg}<br>`; l.scrollTop = l.scrollHeight; }

        function getGbaString(offset) {
            let str = "";
            let i = offset;
            while (i < romBuffer.length && romBuffer[i] !== 0xFF) {
                str += charMap[romBuffer[i]] || '';
                i++;
                if (str.length > 1000) break;
            }
            return str;
        }

        function exportText() {
            if (!romBuffer) return alert("Carica prima la ROM!");
            log("Inizio scansione selettiva...");
            
            let exportData = "--- GBA TRANSLATION FILE ---\n";
            let count = 0;

            for (let i = 0x100000; i < romBuffer.length - 12; i++) {
                // Filtro Dialoghi (Stringhe lunghe)
                if (document.getElementById('checkDialogs').checked && romBuffer[i] >= 0xBB && romBuffer[i] <= 0xD4) {
                    let str = getGbaString(i);
                    if (str.length > 25) { // Solo frasi vere
                        exportData += `0x${i.toString(16).toUpperCase()} | ${str}\n`;
                        i += str.length; count++;
                        continue;
                    }
                }
                
                // Filtro Mosse/Oggetti (Basato su lunghezza tipica delle tabelle)
                // In Gen 3 le mosse sono spesso tra 0x200000 e 0x300000
                let isTableRange = (i > 0x200000 && i < 0x400000);
                if ((document.getElementById('checkMoves').checked || document.getElementById('checkItems').checked) && isTableRange) {
                    if (romBuffer[i] >= 0xBB && romBuffer[i] <= 0xD4) {
                        let str = getGbaString(i);
                        if (str.length >= 3 && str.length <= 13) {
                            exportData += `0x${i.toString(16).toUpperCase()} | ${str}\n`;
                            i += str.length; count++;
                        }
                    }
                }
            }

            const blob = new Blob([exportData], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = "TRADUZIONE_FILTRATA.txt"; a.click();
            log(`Esportate ${count} stringhe filtrate.`);
        }

        async function importText() {
            const file = document.getElementById('importFile').files[0];
            if (!file || !romBuffer) return alert("Carica i file necessari!");
            const text = await file.text();
            const lines = text.split('\n');
            let patched = 0;

            lines.forEach(line => {
                if (!line.includes('|')) return;
                const [offStr, newText] = line.split('|').map(s => s.trim());
                const offset = parseInt(offStr, 16);
                
                let bytes = [];
                for (let char of newText) { bytes.push(invMap[char] || 0x00); }
                bytes.push(0xFF);

                // Applichiamo la patch (No Repointing in questa versione veloce, tronca se troppo lunga)
                let maxLen = 0;
                while (romBuffer[offset + maxLen] !== 0xFF) maxLen++;
                
                for (let i = 0; i <= maxLen; i++) {
                    romBuffer[offset + i] = (i < bytes.length) ? bytes[i] : 0x00;
                }
                patched++;
            });

            log(`Patch completata: ${patched} stringhe.`);
            const blob = new Blob([romBuffer], { type: 'application/octet-stream' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = "ROM_TRADOTTA_FILTRATA.gba"; a.click();
        }
    </script>
</body>
</html>

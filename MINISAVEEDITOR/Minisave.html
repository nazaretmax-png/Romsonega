<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>DL2 Save Editor</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Syne+Mono&family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg:     #0B0B0B;
  --s1:     #131313;
  --s2:     #1A1A1A;
  --line:   #222;
  --line2:  #2C2C2C;
  --gold:   #C9900A;
  --gold2:  #EAB32A;
  --goldd:  #9A6F06;
  --txt:    #D8D5CE;
  --muted:  #484844;
  --green:  #4EC994;
  --red:    #D95050;
  --blue:   #5899D4;
  --mono:   'Syne Mono', monospace;
  --sans:   'Syne', sans-serif;
  --r:      6px;
}

html { font-size: 15px; }

body {
  background: var(--bg);
  color: var(--txt);
  font-family: var(--sans);
  min-height: 100dvh;
  display: flex;
  flex-direction: column;
  align-items: center;
}

.shell {
  width: 100%;
  max-width: 600px;
  display: flex;
  flex-direction: column;
  min-height: 100dvh;
}

/* ‚îÄ‚îÄ Header ‚îÄ‚îÄ‚îÄ */
header {
  padding: 20px 20px 0;
  display: flex;
  align-items: baseline;
  justify-content: space-between;
}

.logo {
  font-weight: 800;
  font-size: 1.05rem;
  letter-spacing: .08em;
  text-transform: uppercase;
  color: #fff;
}

.logo em { color: var(--gold); font-style: normal; }

.ver {
  font-family: var(--mono);
  font-size: .65rem;
  color: var(--muted);
}

main {
  flex: 1;
  padding: 20px 20px;
  display: flex;
  flex-direction: column;
  gap: 0;
}

/* ‚îÄ‚îÄ Section ‚îÄ‚îÄ‚îÄ */
.sec {
  border-top: 1px solid var(--line);
  padding: 18px 0;
  opacity: 0;
  transform: translateY(6px);
  animation: up .3s forwards;
}
.sec:nth-child(1){animation-delay:.03s}
.sec:nth-child(2){animation-delay:.08s}
.sec:nth-child(3){animation-delay:.13s}

@keyframes up { to { opacity:1; transform:translateY(0); } }

.sec-label {
  font-family: var(--mono);
  font-size: .63rem;
  color: var(--muted);
  letter-spacing: .14em;
  text-transform: uppercase;
  margin-bottom: 14px;
  display: flex;
  align-items: center;
  gap: 8px;
}
.sec-label::after { content:''; flex:1; height:1px; background:var(--line); }

/* ‚îÄ‚îÄ Drop zone ‚îÄ‚îÄ‚îÄ */
.drop {
  border: 1px solid var(--line);
  border-radius: var(--r);
  padding: 26px 20px;
  text-align: center;
  cursor: pointer;
  position: relative;
  background: var(--s1);
  transition: border-color .18s, background .18s;
}
.drop:hover, .drop.drag { border-color: var(--gold); background: var(--s2); }
.drop input { position:absolute; inset:0; opacity:0; width:100%; height:100%; cursor:pointer; }
.drop svg { display:block; margin:0 auto 10px; opacity:.28; }
.drop-title { display:block; font-size:.88rem; font-weight:700; color:var(--txt); }
.drop-sub { display:block; font-family:var(--mono); font-size:.65rem; color:var(--muted); margin-top:3px; }

/* ‚îÄ‚îÄ Status bar after file load ‚îÄ‚îÄ‚îÄ */
.file-bar {
  display: none;
  align-items: center;
  gap: 10px;
  margin-top: 10px;
  background: var(--s2);
  border: 1px solid var(--line);
  border-radius: var(--r);
  padding: 10px 14px;
}
.file-bar.show { display: flex; }
.fb-dot { width:7px; height:7px; border-radius:50%; background:var(--green); box-shadow:0 0 7px var(--green); flex-shrink:0; }
.fb-name { font-family:var(--mono); font-size:.73rem; color:var(--green); flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
.fb-info { font-family:var(--mono); font-size:.63rem; color:var(--muted); flex-shrink:0; }

/* ‚îÄ‚îÄ Editor panel (hidden until file loaded) ‚îÄ‚îÄ‚îÄ */
#editorPanel { display: none; }
#editorPanel.show { display: block; }

/* ‚îÄ‚îÄ Player info strip ‚îÄ‚îÄ‚îÄ */
.player-strip {
  display: flex;
  align-items: center;
  gap: 14px;
  background: var(--s1);
  border: 1px solid var(--line);
  border-radius: var(--r);
  padding: 12px 16px;
  margin-bottom: 14px;
}
.avatar {
  width: 42px; height: 42px;
  border-radius: 50%;
  background: linear-gradient(135deg, #2a2a1a, #1a1a0a);
  border: 1px solid var(--gold);
  display: grid; place-items: center;
  font-size: 1.3rem;
  flex-shrink: 0;
}
.player-name { font-weight: 700; font-size: .95rem; color: #fff; }
.player-meta { font-family: var(--mono); font-size: .63rem; color: var(--muted); margin-top: 2px; }
.player-meta span { color: var(--gold); }

/* ‚îÄ‚îÄ Field groups ‚îÄ‚îÄ‚îÄ */
.group {
  margin-bottom: 16px;
}
.group-title {
  font-family: var(--mono);
  font-size: .62rem;
  color: var(--muted);
  letter-spacing: .12em;
  text-transform: uppercase;
  margin-bottom: 8px;
}

/* ‚îÄ‚îÄ Money card (special) ‚îÄ‚îÄ‚îÄ */
.money-card {
  background: var(--s1);
  border: 1px solid var(--gold);
  border-radius: var(--r);
  padding: 14px 16px;
  margin-bottom: 8px;
  position: relative;
  overflow: hidden;
}
.money-card::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 1px;
  background: linear-gradient(90deg, transparent, var(--gold2), transparent);
  opacity: .4;
}
.money-top {
  display: flex;
  justify-content: space-between;
  align-items: baseline;
  margin-bottom: 10px;
}
.money-label {
  font-family: var(--mono);
  font-size: .62rem;
  color: var(--muted);
  letter-spacing: .1em;
  text-transform: uppercase;
}
.money-current {
  font-family: var(--mono);
  font-size: .75rem;
  color: var(--gold);
}
.money-row {
  display: grid;
  grid-template-columns: 1fr auto;
  gap: 8px;
  align-items: center;
}
.money-input-wrap { position: relative; flex:1; }
.money-input-wrap input {
  background: var(--s2);
  border: 1px solid var(--line2);
  color: #fff;
  border-radius: var(--r);
  padding: 11px 14px;
  font-family: var(--mono);
  font-size: .95rem;
  font-weight: 700;
  width: 100%;
  min-height: 44px;
  transition: border-color .14s;
}
.money-input-wrap input:focus { outline:none; border-color:var(--gold); }
.money-presets {
  display: flex;
  gap: 6px;
  margin-top: 8px;
  flex-wrap: wrap;
}
.preset {
  font-family: var(--mono);
  font-size: .65rem;
  padding: 4px 10px;
  border-radius: 20px;
  border: 1px solid var(--line2);
  background: transparent;
  color: var(--muted);
  cursor: pointer;
  transition: border-color .14s, color .14s;
  min-height: 30px;
}
.preset:hover { border-color: var(--gold); color: var(--gold); }

/* ‚îÄ‚îÄ Stat grid ‚îÄ‚îÄ‚îÄ */
.stat-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 8px;
}
.stat-grid.four { grid-template-columns: repeat(4, 1fr); }

.stat-cell {
  background: var(--s1);
  border: 1px solid var(--line);
  border-radius: var(--r);
  padding: 10px 12px;
  display: flex;
  flex-direction: column;
  gap: 5px;
}
.stat-label {
  font-family: var(--mono);
  font-size: .58rem;
  color: var(--muted);
  letter-spacing: .1em;
  text-transform: uppercase;
}
.stat-cell input, .stat-cell select {
  background: transparent;
  border: none;
  color: #fff;
  font-family: var(--mono);
  font-size: .9rem;
  font-weight: 600;
  width: 100%;
  padding: 0;
  appearance: none;
  -webkit-appearance: none;
  min-height: 24px;
}
.stat-cell input:focus, .stat-cell select:focus { outline: none; color: var(--gold); }
.stat-cell select { cursor: pointer; }

/* ‚îÄ‚îÄ Flat row fields ‚îÄ‚îÄ‚îÄ */
.field-row {
  display: flex;
  align-items: center;
  background: var(--s1);
  border: 1px solid var(--line);
  border-radius: var(--r);
  padding: 11px 14px;
  gap: 12px;
  margin-bottom: 6px;
}
.field-row + .field-row { border-top: none; border-radius: 0; margin-top: -1px; }
.field-row:first-child { border-radius: var(--r) var(--r) 0 0; }
.field-row:last-child  { border-radius: 0 0 var(--r) var(--r); }
.field-row:only-child  { border-radius: var(--r); }
.fr-label {
  font-family: var(--mono);
  font-size: .68rem;
  color: var(--muted);
  flex: 1;
}
.fr-label strong { color: var(--txt); font-weight: 600; display:block; font-size:.78rem; font-family: var(--sans); }
.fr-input {
  background: transparent;
  border: none;
  color: #fff;
  font-family: var(--mono);
  font-size: .85rem;
  font-weight: 600;
  text-align: right;
  width: 90px;
  min-height: 24px;
  padding: 0;
}
.fr-input:focus { outline: none; color: var(--gold); }
.fr-input.wide { width: 130px; }

/* ‚îÄ‚îÄ Action buttons ‚îÄ‚îÄ‚îÄ */
.btn-row { display: flex; gap: 8px; margin-top: 4px; }
.btn {
  flex: 1;
  border: none;
  border-radius: var(--r);
  padding: 13px 14px;
  font-family: var(--sans);
  font-size: .78rem;
  font-weight: 700;
  letter-spacing: .05em;
  text-transform: uppercase;
  cursor: pointer;
  min-height: 48px;
  transition: opacity .14s, transform .1s, background .14s;
}
.btn:active { transform: scale(.97); }
.btn-gold { background: var(--gold); color: #000; }
.btn-gold:hover { background: var(--gold2); }
.btn-ghost {
  background: transparent;
  border: 1px solid var(--line2);
  color: var(--muted);
}
.btn-ghost:hover { border-color: var(--txt); color: var(--txt); }
.btn-dl {
  background: var(--s2);
  border: 1px solid var(--line2);
  color: var(--txt);
}
.btn-dl:hover { border-color: var(--green); color: var(--green); }
.btn-dl:disabled, .btn-gold:disabled { opacity:.3; cursor:not-allowed; transform:none; }

/* ‚îÄ‚îÄ Toast ‚îÄ‚îÄ‚îÄ */
#toast {
  position: fixed;
  bottom: 24px;
  left: 50%;
  transform: translateX(-50%) translateY(80px);
  background: var(--s2);
  border: 1px solid var(--line2);
  border-radius: 30px;
  padding: 10px 20px;
  font-family: var(--mono);
  font-size: .72rem;
  color: var(--txt);
  white-space: nowrap;
  transition: transform .25s ease, opacity .25s;
  opacity: 0;
  z-index: 100;
}
#toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
#toast.ok { border-color: var(--green); color: var(--green); }
#toast.err { border-color: var(--red); color: var(--red); }

/* ‚îÄ‚îÄ Diff badge ‚îÄ‚îÄ‚îÄ */
.diff {
  font-family: var(--mono);
  font-size: .6rem;
  padding: 2px 7px;
  border-radius: 10px;
  background: rgba(78,201,148,.12);
  border: 1px solid rgba(78,201,148,.25);
  color: var(--green);
  display: none;
}
.diff.show { display: inline-block; }

/* ‚îÄ‚îÄ Footer ‚îÄ‚îÄ‚îÄ */
footer {
  padding: 12px 20px max(12px, env(safe-area-inset-bottom));
  border-top: 1px solid var(--line);
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.fstat {
  display: flex; align-items: center; gap: 7px;
  font-family: var(--mono); font-size: .62rem; color: var(--muted);
}
.fdot {
  width: 6px; height: 6px; border-radius: 50%;
  background: var(--muted);
  transition: background .3s, box-shadow .3s;
}
.fdot.on { background: var(--green); box-shadow: 0 0 6px var(--green); }

@media (max-width: 420px) {
  .stat-grid.four { grid-template-columns: repeat(2, 1fr); }
  .btn-row { flex-direction: column; }
  .money-row { grid-template-columns: 1fr; }
}
</style>
</head>
<body>
<div class="shell">

<header>
  <span class="logo">DL2 <em>Save</em> Editor</span>
  <span class="ver">v3.0 ‚Äî smart</span>
</header>

<main>

  <!-- STEP 1: CARICA FILE -->
  <div class="sec">
    <div class="sec-label">carica il tuo salvataggio</div>

    <div class="drop" id="drop">
      <input type="file" id="fileInput" accept=".dat,.sav">
      <svg width="32" height="32" viewBox="0 0 32 32" fill="none">
        <rect x="3" y="3" width="26" height="26" rx="3.5" stroke="#D8D5CE" stroke-width="1.4"/>
        <path d="M16 10v12M11 17l5 5 5-5" stroke="#D8D5CE" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      <span class="drop-title">Trascina il file qui, o clicca</span>
      <span class="drop-sub">savegame1.dat ¬∑ .sav ¬∑ Dealer's Life 2</span>
    </div>

    <div class="file-bar" id="fileBar">
      <div class="fb-dot"></div>
      <span class="fb-name" id="fbName">‚Äî</span>
      <span class="fb-info" id="fbInfo">‚Äî</span>
    </div>
  </div>

  <!-- STEP 2: EDITOR (mostrato dopo caricamento) -->
  <div class="sec" id="editorPanel">

    <!-- Player strip -->
    <div class="player-strip" id="playerStrip">
      <div class="avatar" id="avatarEl">üé∞</div>
      <div>
        <div class="player-name" id="playerName">‚Äî</div>
        <div class="player-meta">Giorno <span id="metaDay">‚Äî</span> ¬∑ Difficolt√† <span id="metaDiff">‚Äî</span> ¬∑ Rep. <span id="metaRep">‚Äî</span></div>
      </div>
    </div>

    <!-- SOLDI -->
    <div class="group">
      <div class="group-title">üí∞ &nbsp;soldi</div>
      <div class="money-card">
        <div class="money-top">
          <span class="money-label">Saldo corrente</span>
          <span class="money-current" id="moneyDisplay">‚Äî</span>
        </div>
        <div class="money-row">
          <div class="money-input-wrap">
            <input type="number" id="cashInput" placeholder="Nuovo importo" min="0" step="1"
                   oninput="onCashInput()">
          </div>
        </div>
        <div class="money-presets">
          <button class="preset" onclick="setPreset(10000)">10.000</button>
          <button class="preset" onclick="setPreset(50000)">50.000</button>
          <button class="preset" onclick="setPreset(100000)">100.000</button>
          <button class="preset" onclick="setPreset(500000)">500.000</button>
          <button class="preset" onclick="setPreset(1000000)">1.000.000</button>
        </div>
      </div>
    </div>

    <!-- STATISTICHE GIOCATORE -->
    <div class="group">
      <div class="group-title">üß† &nbsp;abilit√† giocatore</div>
      <div class="stat-grid four">
        <div class="stat-cell">
          <span class="stat-label">Carisma</span>
          <input type="number" id="statCharisma" min="0" max="100" oninput="markDirty()">
        </div>
        <div class="stat-cell">
          <span class="stat-label">Competenza</span>
          <input type="number" id="statCompetence" min="0" max="100" oninput="markDirty()">
        </div>
        <div class="stat-cell">
          <span class="stat-label">Intuito</span>
          <input type="number" id="statInsight" min="0" max="100" oninput="markDirty()">
        </div>
        <div class="stat-cell">
          <span class="stat-label">Fortuna</span>
          <input type="number" id="statLuck" min="0" max="100" oninput="markDirty()">
        </div>
      </div>
    </div>

    <!-- NEGOZIO & ALTRO -->
    <div class="group">
      <div class="group-title">üè™ &nbsp;negozio e gioco</div>
      <div class="field-row">
        <div class="fr-label"><strong>Reputazione</strong>fame points nel gioco</div>
        <input class="fr-input" type="number" id="statRep" min="0" oninput="markDirty()">
      </div>
      <div class="field-row">
        <div class="fr-label"><strong>Cariche Expert</strong>numero utilizzi disponibili</div>
        <input class="fr-input" type="number" id="statExpert" min="0" oninput="markDirty()">
      </div>
      <div class="field-row">
        <div class="fr-label"><strong>Cariche Brainwasher</strong>numero utilizzi disponibili</div>
        <input class="fr-input" type="number" id="statBrain" min="0" oninput="markDirty()">
      </div>
      <div class="field-row">
        <div class="fr-label"><strong>Giorno corrente</strong>avanza nel tempo</div>
        <input class="fr-input" type="number" id="statDay" min="1" oninput="markDirty()">
      </div>
    </div>

    <!-- PULSANTI -->
    <div class="btn-row">
      <button class="btn btn-gold" id="btnApply" onclick="applyChanges()">
        ‚úì &nbsp;Applica e Scarica
      </button>
      <button class="btn btn-ghost" onclick="resetEditor()">
        Annulla
      </button>
    </div>
    <div class="btn-row" style="margin-top:8px">
      <button class="btn btn-dl" id="btnBak" onclick="downloadBackup()">
        ‚Üì &nbsp;Scarica Backup .bak
      </button>
    </div>

  </div>

</main>

<footer>
  <div class="fstat">
    <div class="fdot" id="fdot"></div>
    <span id="fst">NESSUN FILE</span>
  </div>
  <span style="font-family:var(--mono);font-size:.58rem;color:var(--muted);opacity:.4">DEALER'S LIFE 2</span>
</footer>

</div>

<div id="toast"></div>

<script>
const XOR_KEY = 0x7B;   // chiave XOR di Dealer's Life 2 ‚Äî rilevata automaticamente

let rawBytes = null;    // Uint8Array originale (cifrato)
let saveData = null;    // oggetto JSON parsato
let fileName = '';

/* ‚îÄ‚îÄ‚îÄ File load ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
const drop = document.getElementById('drop');
drop.addEventListener('dragover',  e => { e.preventDefault(); drop.classList.add('drag'); });
drop.addEventListener('dragleave', () => drop.classList.remove('drag'));
drop.addEventListener('drop', e => {
  e.preventDefault(); drop.classList.remove('drag');
  const f = e.dataTransfer.files[0]; if (f) loadFile(f);
});
document.getElementById('fileInput').onchange = e => {
  const f = e.target.files[0]; if (f) loadFile(f);
};

function loadFile(file) {
  fileName = file.name;
  const reader = new FileReader();
  reader.onload = ev => {
    rawBytes = new Uint8Array(ev.target.result);
    try {
      const json = decodeXOR(rawBytes);
      saveData = JSON.parse(json);
    } catch (err) {
      toast('‚ùå File non riconosciuto o formato errato', 'err');
      return;
    }
    // aggiorna UI
    document.getElementById('fileBar').classList.add('show');
    document.getElementById('fbName').textContent = fileName;
    document.getElementById('fbInfo').textContent = fmtBytes(rawBytes.length) + ' ¬∑ JSON+XOR 0x7B';
    setStatus(fmtBytes(rawBytes.length), true);
    populateEditor();
    document.getElementById('editorPanel').classList.add('show');
    toast('‚úì File caricato correttamente', 'ok');
  };
  reader.readAsArrayBuffer(file);
}

/* ‚îÄ‚îÄ‚îÄ Decode / Encode ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function decodeXOR(buf) {
  return new TextDecoder().decode(buf.map(b => b ^ XOR_KEY));
}

function encodeXOR(jsonStr) {
  const bytes = new TextEncoder().encode(jsonStr);
  return bytes.map(b => b ^ XOR_KEY);
}

/* ‚îÄ‚îÄ‚îÄ Popola editor ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function populateEditor() {
  const d  = saveData;
  const p  = d.player;
  const cash = d.cash.value + d.cash.offset;

  // Player strip
  const avatars = ['üé∞','üÉè','üíº','üß≥','üíé','ü™ô','üèÜ','üé©'];
  document.getElementById('avatarEl').textContent = avatars[p.avatarId] || 'üé∞';
  document.getElementById('playerName').textContent = p.nickname || 'Giocatore';
  document.getElementById('metaDay').textContent  = d.day;
  document.getElementById('metaDiff').textContent = ['Facile','Normale','Difficile'][d.difficulty] || d.difficulty;
  document.getElementById('metaRep').textContent  = p.reputation;

  // Soldi
  document.getElementById('moneyDisplay').textContent = fmtMoney(cash);
  document.getElementById('cashInput').value = cash;

  // Abilit√†
  document.getElementById('statCharisma').value   = p.charisma;
  document.getElementById('statCompetence').value = p.competence;
  document.getElementById('statInsight').value    = p.insight;
  document.getElementById('statLuck').value       = p.luck;

  // Negozio e altro
  document.getElementById('statRep').value    = p.reputation;
  document.getElementById('statExpert').value = d.shop.expertCharges;
  document.getElementById('statBrain').value  = d.shop.brainwasherCharges;
  document.getElementById('statDay').value    = d.day;
}

/* ‚îÄ‚îÄ‚îÄ Preset soldi ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function setPreset(v) {
  document.getElementById('cashInput').value = v;
  onCashInput();
}

function onCashInput() {
  markDirty();
}

/* ‚îÄ‚îÄ‚îÄ Dirty marker ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function markDirty() { /* no-op visivo; salva al click */ }

/* ‚îÄ‚îÄ‚îÄ Applica e scarica ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function applyChanges() {
  if (!saveData) return;

  const d = saveData;
  const p = d.player;

  // Soldi: aggiusta .value, azzera .offset
  const newCash = parseInt(document.getElementById('cashInput').value) || 0;
  d.cash.value  = newCash;
  d.cash.offset = 0;

  // Abilit√†
  p.charisma   = clamp(parseInt(document.getElementById('statCharisma').value)   || 0, 0, 100);
  p.competence = clamp(parseInt(document.getElementById('statCompetence').value) || 0, 0, 100);
  p.insight    = clamp(parseInt(document.getElementById('statInsight').value)    || 0, 0, 100);
  p.luck       = clamp(parseInt(document.getElementById('statLuck').value)       || 0, 0, 100);

  // Negozio e altro
  p.reputation = parseInt(document.getElementById('statRep').value)    || 0;
  d.shop.expertCharges       = parseInt(document.getElementById('statExpert').value) || 0;
  d.shop.brainwasherCharges  = parseInt(document.getElementById('statBrain').value)  || 0;
  d.day = parseInt(document.getElementById('statDay').value) || d.day;

  // Serializza e cifra
  const json    = JSON.stringify(d);
  const encoded = encodeXOR(json);

  // Backup automatico prima del download
  downloadBackup();

  // Download file modificato
  dlBuffer(encoded, 'MODIFIED_' + fileName);
  toast('‚úì File modificato scaricato!', 'ok');

  // Aggiorna display soldi
  document.getElementById('moneyDisplay').textContent = fmtMoney(newCash);
  document.getElementById('metaRep').textContent = p.reputation;
  document.getElementById('metaDay').textContent = d.day;
}

/* ‚îÄ‚îÄ‚îÄ Download backup ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function downloadBackup() {
  if (!rawBytes) return;
  dlBuffer(rawBytes, fileName + '.bak');
  toast('Backup .bak scaricato', 'ok');
}

/* ‚îÄ‚îÄ‚îÄ Reset ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function resetEditor() {
  if (!saveData) return;
  populateEditor();
  toast('Modifiche annullate', '');
}

/* ‚îÄ‚îÄ‚îÄ Utils ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function dlBuffer(data, name) {
  const url = URL.createObjectURL(new Blob([data], { type: 'application/octet-stream' }));
  const a = Object.assign(document.createElement('a'), { href: url, download: name });
  a.click();
  setTimeout(() => URL.revokeObjectURL(url), 1000);
}

function fmtMoney(n) {
  return n.toLocaleString('it-IT') + ' ‚Ç¨';
}

function fmtBytes(n) {
  if (n < 1024) return n + ' B';
  if (n < 1048576) return (n / 1024).toFixed(1) + ' KB';
  return (n / 1048576).toFixed(2) + ' MB';
}

function clamp(v, min, max) { return Math.min(Math.max(v, min), max); }

function setStatus(txt, on) {
  document.getElementById('fst').textContent = txt;
  document.getElementById('fdot').classList.toggle('on', on);
}

let toastTimer;
function toast(msg, type) {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.className = 'show ' + (type || '');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => el.className = '', 3000);
}
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GBA Translator Ultra - Final Edition</title>
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --accent: #0ea5e9; --success: #22c55e; --warn: #f59e0b; --err: #ef4444; --text: #f1f5f9; }
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); color: var(--text); padding: 10px; margin: 0; display: flex; flex-direction: column; align-items: center; }
        .container { width: 100%; max-width: 900px; }
        h1 { color: var(--accent); text-align: center; font-size: 1.6rem; margin: 10px 0; }
        .card { background: var(--card); padding: 20px; border-radius: 15px; border: 1px solid #334155; margin-bottom: 15px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.3); }
        h3 { margin-top: 0; color: #94a3b8; font-size: 1.1rem; border-bottom: 1px solid #334155; padding-bottom: 10px; }
        .status-badge { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 12px; background: #334155; margin-bottom: 15px; font-weight: bold; }
        input, select, button { width: 100%; padding: 14px; margin: 8px 0; border-radius: 10px; border: 1px solid #475569; background: #0f172a; color: white; font-size: 16px; box-sizing: border-box; }
        button { background: var(--accent); color: white; border: none; font-weight: bold; cursor: pointer; transition: 0.2s; }
        button:active { transform: scale(0.98); }
        .btn-patch { background: var(--success); }
        .btn-outline { background: transparent; border: 2px solid var(--accent); color: var(--accent); }
        .log-area { background: #000; border-radius: 8px; height: 120px; overflow-y: auto; font-family: monospace; font-size: 12px; padding: 10px; border: 1px solid #334155; color: #cbd5e1; }
        .progress-container { background: #000; height: 12px; border-radius: 6px; overflow: hidden; display: none; margin: 10px 0; }
        .progress-bar { height: 100%; background: linear-gradient(90deg, var(--accent), var(--success)); width: 0%; transition: width 0.3s; }
        .results-preview { height: 300px; overflow-y: auto; background: #000; border-radius: 8px; border: 1px solid #334155; margin-top: 10px; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th { background: #1e293b; color: var(--accent); padding: 10px; text-align: left; position: sticky; top: 0; }
        td { padding: 8px; border-bottom: 1px solid #1e293b; }
        .blue-text { color: #38bdf8; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <h1>GBA Translator Ultra üöÄ</h1>
    <div id="fileState" class="status-badge">üî¥ Nessuna ROM</div>

    <div class="card">
        <h3>1. Caricamento Progetto</h3>
        <input type="file" id="romIn" accept=".gba">
    </div>

    <div class="card">
        <h3>2. Estrazione Intelligente</h3>
        <select id="extractMode">
            <option value="moves">‚öîÔ∏è Solo Mosse (3-12 caratteri, pulite)</option>
            <option value="items">üéí Solo Oggetti (3-16 caratteri)</option>
            <option value="dialogs">üí¨ Solo Dialoghi (Frasi lunghe, messaggi)</option>
            <option value="all">üîç Tutto (Usa con cautela)</option>
        </select>
        <button onclick="runAdvancedScan()">Avvia Scansione Filtrata</button>
        <div class="progress-container" id="progCont"><div class="progress-bar" id="progBar"></div></div>
        <div class="results-preview">
            <table>
                <thead><tr><th>Offset</th><th>Spazio</th><th>Testo Originale</th></tr></thead>
                <tbody id="resTable"></tbody>
            </table>
        </div>
        <button class="btn-outline" onclick="downloadTxt()">üíæ Scarica Lista Traduzione (.txt)</button>
    </div>

    <div class="card">
        <h3>3. Patch & Auto-Repoint</h3>
        <p style="font-size: 12px; color: #94a3b8;">Carica il file tradotto. Il sistema sposter√† automaticamente le parole lunghe in zone sicure della ROM.</p>
        <input type="file" id="txtIn" accept=".txt">
        <button class="btn-patch" onclick="applySmartPatch()">‚ö° Applica Traduzione alla ROM</button>
    </div>

    <div class="card">
        <h3>Console Log</h3>
        <div id="consoleLog" class="log-area">Pronto all'uso...</div>
    </div>
</div>

<script>
    const charMap = { 0x00: ' ', 0x01: '√Ä', 0x02: '√Å', 0x03: '√Ç', 0x04: '√á', 0x05: '√à', 0x06: '√â', 0x07: '√ä', 0x08: '√ã', 0x09: '√å', 0x0B: '√é', 0x0C: '√è', 0x0D: '√í', 0x0E: '√ì', 0x0F: '√î', 0x10: '≈í', 0x11: '√ô', 0x12: '√ö', 0x13: '√õ', 0x14: '≈∏', 0x15: '√ü', 0x16: '√†', 0x17: '√°', 0x19: '√ß', 0x1A: '√®', 0x1B: '√©', 0x1C: '√™', 0x1D: '√´', 0x1E: '√¨', 0x20: '√Æ', 0x21: '√Ø', 0x22: '√≤', 0x23: '√≥', 0x24: '√¥', 0x25: '≈ì', 0x26: '√π', 0x27: '√∫', 0x28: '√ª', 0x29: '√ø', 0x2D: '&', 0x2E: '+', 0xAB: '!', 0xAC: '?', 0xAD: '.', 0xAE: '-', 0xB0: '...', 0xB8: ',', 0xBB: 'A', 0xBC: 'B', 0xBD: 'C', 0xBE: 'D', 0xBF: 'E', 0xC0: 'F', 0xC1: 'G', 0xC2: 'H', 0xC3: 'I', 0xC4: 'J', 0xC5: 'K', 0xC6: 'L', 0xC7: 'M', 0xC8: 'N', 0xC9: 'O', 0xCA: 'P', 0xCB: 'Q', 0xCC: 'R', 0xCD: 'S', 0xCE: 'T', 0xCF: 'U', 0xD0: 'V', 0xD1: 'W', 0xD2: 'X', 0xD3: 'Y', 0xD4: 'Z', 0xD5: 'a', 0xD6: 'b', 0xD7: 'c', 0xD8: 'd', 0xD9: 'e', 0xDA: 'f', 0xDB: 'g', 0xDC: 'h', 0xDD: 'i', 0xDE: 'j', 0xDF: 'k', 0xE0: 'l', 0xE1: 'm', 0xE2: 'n', 0xE3: 'o', 0xE4: 'p', 0xE5: 'q', 0xE6: 'r', 0xE7: 's', 0xE8: 't', 0xE9: 'u', 0xEA: 'v', 0xEB: 'w', 0xEC: 'x', 0xED: 'y', 0xEE: 'z', 0xFA: '\\l', 0xFB: '\\p', 0xFE: '\\n' };
    const invMap = Object.fromEntries(Object.entries(charMap).map(([k,v]) => [v, parseInt(k)]));
    
    let rom = null;
    let extractedStrings = [];

    function printLog(m, type="") {
        const c = document.getElementById('consoleLog');
        const color = type === "err" ? "#ef4444" : type === "ok" ? "#22c55e" : "#cbd5e1";
        c.innerHTML += `<div style="color: ${color}">> ${m}</div>`;
        c.scrollTop = c.scrollHeight;
    }

    document.getElementById('romIn').onchange = function(e) {
        const r = new FileReader();
        r.onload = () => {
            rom = new Uint8Array(r.result);
            document.getElementById('fileState').innerText = "üü¢ ROM PRONTA";
            document.getElementById('fileState').style.background = "#14532d";
            printLog("ROM Caricata: " + rom.length + " bytes", "ok");
        };
        r.readAsArrayBuffer(this.files[0]);
    };

    function runAdvancedScan() {
        if(!rom) return alert("Carica prima la ROM!");
        const mode = document.getElementById('extractMode').value;
        const table = document.getElementById('resTable');
        const pBar = document.getElementById('progBar');
        document.getElementById('progCont').style.display = "block";
        
        table.innerHTML = "";
        extractedStrings = [];
        let i = 0x200000; // Inizio standard dati GBA

        function scanChunk() {
            let chunkLimit = Math.min(i + 0x40000, rom.length);
            for(; i < chunkLimit; i++) {
                // Filtro base: deve iniziare con una lettera (A-Z)
                if(rom[i] >= 0xBB && rom[i] <= 0xD4) {
                    let s = "", j = i, symbols = 0;
                    while(j < rom.length && rom[j] !== 0xFF && s.length < 500) {
                        if(charMap[rom[j]]) {
                            s += charMap[rom[j]];
                            if(rom[j] < 0xBB) symbols++; 
                        } else { symbols += 10; break; } // Carattere non valido = spazzatura
                        j++;
                    }

                    // Filtro Anti-Junk: se ci sono troppi simboli strani o la stringa √® vuota, scarta
                    if(symbols < (s.length / 2) && s.trim().length > 2) {
                        let pass = false;
                        const len = s.length;

                        if(mode === "moves") pass = (len >= 3 && len <= 12 && !s.includes('\\'));
                        else if(mode === "items") pass = (len >= 3 && len <= 16 && !s.includes('\\'));
                        else if(mode === "dialogs") pass = (len > 20 || s.includes('\\'));
                        else if(mode === "all") pass = true;

                        if(pass) {
                            const offHex = "0x" + i.toString(16).toUpperCase();
                            const space = j - i;
                            extractedStrings.push({o: offHex, t: s, s: space});
                            if(extractedStrings.length < 100) {
                                table.insertAdjacentHTML('beforeend', `<tr><td class="blue-text">${offHex}</td><td>${space}b</td><td>${s}</td></tr>`);
                            }
                            i = j;
                        }
                    }
                }
            }
            pBar.style.width = (i / rom.length * 100) + "%";
            if(i < rom.length - 1) requestAnimationFrame(scanChunk);
            else {
                printLog("Scansione completata. Trovate " + extractedStrings.length + " stringhe valide.", "ok");
                alert("Trovate " + extractedStrings.length + " stringhe coerenti!");
            }
        }
        scanChunk();
    }

    function downloadTxt() {
        if(extractedStrings.length === 0) return alert("Esegui prima la scansione!");
        let out = "--- GBA TRANSLATION FILE ---\nFORMATO: OFFSET | SPAZIO_ORIGINALE | TESTO\n\n";
        extractedStrings.forEach(x => out += `${x.o} | ${x.s} | ${x.t}\n`);
        const b = new Blob([out], {type: 'text/plain'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(b);
        a.download = "Lista_" + document.getElementById('extractMode').value + ".txt";
        a.click();
    }

    function findFreeSpace(size) {
        let count = 0;
        for(let i = rom.length - 1; i > 0x800000; i--) {
            if(rom[i] === 0xFF) count++; else count = 0;
            if(count >= size + 16) return i + 4;
        }
        return -1;
    }

    function repoint(oldOff, newOff) {
        const oldPtr = new Uint8Array([oldOff & 0xFF, (oldOff >> 8) & 0xFF, (oldOff >> 16) & 0xFF, 0x08]);
        const newPtr = new Uint8Array([newOff & 0xFF, (newOff >> 8) & 0xFF, (newOff >> 16) & 0xFF, 0x08]);
        let found = 0;
        for(let i = 0; i < rom.length - 4; i++) {
            if(rom[i] === oldPtr[0] && rom[i+1] === oldPtr[1] && rom[i+2] === oldPtr[2] && rom[i+3] === oldPtr[3]) {
                rom.set(newPtr, i);
                found++;
            }
        }
        return found;
    }

    async function applySmartPatch() {
        const file = document.getElementById('txtIn').files[0];
        if(!file || !rom) return alert("ROM o TXT mancante!");
        const txt = await file.text();
        const lines = txt.split('\n');
        let d = 0, r = 0;

        printLog("Inizio Patching...");
        
        lines.forEach(line => {
            if(!line.includes('|') || line.startsWith('-')) return;
            const parts = line.split('|').map(s => s.trim());
            const offset = parseInt(parts[0], 16);
            const origSpace = parseInt(parts[1]);
            const text = parts[2];

            // Converti in byte
            let bytes = [];
            for(let k=0; k<text.length; k++) {
                if(text[k] === '\\' && text[k+1]) {
                    if(invMap[text[k]+text[k+1]]) { bytes.push(invMap[text[k]+text[k+1]]); k++; continue; }
                }
                bytes.push(invMap[text[k]] || 0x00);
            }
            bytes.push(0xFF);

            if(bytes.length <= origSpace + 1) {
                rom.set(bytes, offset);
                d++;
            } else {
                const newOff = findFreeSpace(bytes.length);
                if(newOff !== -1) {
                    rom.set(bytes, newOff);
                    repoint(offset, newOff);
                    r++;
                }
            }
        });

        printLog(`Fine! Dirette: ${d}, Ripuntate (Parole lunghe): ${r}`, "ok");
        const b = new Blob([rom], {type: 'application/octet-stream'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(b);
        a.download = "Pokemon_Tradotto.gba";
        a.click();
    }
</script>
</body>
</html>

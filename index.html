<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GBA Rom Translator Pro</title>
    <style>
        :root {
            --bg: #0f172a;
            --card: #1e293b;
            --accent: #38bdf8;
            --success: #10b981;
            --text: #f1f5f9;
        }
        body { font-family: sans-serif; background: var(--bg); color: var(--text); padding: 15px; display: flex; flex-direction: column; align-items: center; }
        .container { width: 100%; max-width: 900px; }
        .card { background: var(--card); padding: 20px; border-radius: 12px; border: 1px solid #334155; margin-bottom: 15px; }
        input, select, button { width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px; border: 1px solid #475569; background: #0f172a; color: white; box-sizing: border-box; }
        button { background: var(--accent); color: #0f172a; font-weight: bold; cursor: pointer; border: none; }
        .btn-success { background: var(--success); }
        .progress-container { margin: 15px 0; background: #000; border-radius: 10px; height: 15px; overflow: hidden; display: none; }
        .progress-bar { height: 100%; background: var(--accent); width: 0%; transition: width 0.3s; }
        .preview { background: #000; height: 350px; overflow-y: auto; border: 1px solid #334155; border-radius: 8px; font-family: monospace; font-size: 13px; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #1e293b; padding: 10px; text-align: left; position: sticky; top: 0; color: var(--accent); }
        td { padding: 8px; border-bottom: 1px solid #1e293b; color: #cbd5e1; }
    </style>
</head>
<body>

<div class="container">
    <h1 style="color: var(--accent); text-align: center;">GBA Translator Pro üöÄ</h1>
    
    <div class="card">
        <h3>1. Carica ROM</h3>
        <input type="file" id="romFile" accept=".gba">
    </div>

    <div class="card">
        <h3>2. Trova Offset (Anti-Matrix)</h3>
        <input type="text" id="searchKeyword" placeholder="Cerca parola (es: POUND)">
        <button onclick="deepSearch()">üîç Trova Indirizzo</button>
    </div>

    <div class="card">
        <h3>3. Estrai e Scarica</h3>
        <input type="text" id="startOffset" placeholder="Offset trovato (es: 0x31977C)">
        <button id="scanBtn" onclick="startExtraction()">üõ∞Ô∏è Avvia Scansione</button>
        <div class="progress-container" id="pContainer"><div class="progress-bar" id="pBar"></div></div>
        <button style="background:none; border: 1px solid var(--accent); color:var(--accent)" onclick="exportToTxt()">üíæ Scarica TXT</button>
    </div>

    <div class="card">
        <div class="preview">
            <table>
                <thead><tr><th>Offset</th><th>Testo</th></tr></thead>
                <tbody id="resBody"></tbody>
            </table>
        </div>
    </div>

    <div class="card">
        <h3>4. Applica Traduzione</h3>
        <input type="file" id="txtFile" accept=".txt">
        <button class="btn-success" onclick="patchRom()">‚ö° Salva ROM ITA</button>
    </div>
</div>

<script>
    const charMap = { 0x00: ' ', 0x01: '√Ä', 0x02: '√Å', 0x03: '√Ç', 0x04: '√á', 0x05: '√à', 0x06: '√â', 0x07: '√ä', 0x08: '√ã', 0x09: '√å', 0x0B: '√é', 0x0C: '√è', 0x0D: '√í', 0x0E: '√ì', 0x0F: '√î', 0x10: '≈í', 0x11: '√ô', 0x12: '√ö', 0x13: '√õ', 0x14: '≈∏', 0x15: '√ü', 0x16: '√†', 0x17: '√°', 0x19: '√ß', 0x1A: '√®', 0x1B: '√©', 0x1C: '√™', 0x1D: '√´', 0x1E: '√¨', 0x20: '√Æ', 0x21: '√Ø', 0x22: '√≤', 0x23: '√≥', 0x24: '√¥', 0x25: '≈ì', 0x26: '√π', 0x27: '√∫', 0x28: '√ª', 0x29: '√ø', 0x2D: '&', 0x2E: '+', 0xAB: '!', 0xAC: '?', 0xAD: '.', 0xAE: '-', 0xB0: '...', 0xB8: ',', 0xBB: 'A', 0xBC: 'B', 0xBD: 'C', 0xBE: 'D', 0xBF: 'E', 0xC0: 'F', 0xC1: 'G', 0xC2: 'H', 0xC3: 'I', 0xC4: 'J', 0xC5: 'K', 0xC6: 'L', 0xC7: 'M', 0xC8: 'N', 0xC9: 'O', 0xCA: 'P', 0xCB: 'Q', 0xCC: 'R', 0xCD: 'S', 0xCE: 'T', 0xCF: 'U', 0xD0: 'V', 0xD1: 'W', 0xD2: 'X', 0xD3: 'Y', 0xD4: 'Z', 0xD5: 'a', 0xD6: 'b', 0xD7: 'c', 0xD8: 'd', 0xD9: 'e', 0xDA: 'f', 0xDB: 'g', 0xDC: 'h', 0xDD: 'i', 0xDE: 'j', 0xDF: 'k', 0xE0: 'l', 0xE1: 'm', 0xE2: 'n', 0xE3: 'o', 0xE4: 'p', 0xE5: 'q', 0xE6: 'r', 0xE7: 's', 0xE8: 't', 0xE9: 'u', 0xEA: 'v', 0xEB: 'w', 0xEC: 'x', 0xED: 'y', 0xEE: 'z', 0xFE: '\n' };
    const invMap = Object.fromEntries(Object.entries(charMap).map(([k,v]) => [v, parseInt(k)]));
    let rom = null;
    let data = [];

    document.getElementById('romFile').onchange = function(e) {
        const reader = new FileReader();
        reader.onload = () => rom = new Uint8Array(reader.result);
        reader.readAsArrayBuffer(this.files[0]);
    };

    function deepSearch() {
        if(!rom) return alert("Carica la ROM!");
        const word = document.getElementById('searchKeyword').value.toUpperCase();
        let bytes = [];
        for(let c of word) bytes.push(invMap[c]);
        for(let i=0; i<rom.length; i++) {
            let match = true;
            for(let j=0; j<bytes.length; j++) if(rom[i+j] !== bytes[j]) { match = false; break; }
            if(match) {
                const hex = "0x" + i.toString(16).toUpperCase();
                document.getElementById('startOffset').value = hex;
                alert("Trovato! Offset: " + hex);
                return;
            }
        }
        alert("Non trovato!");
    }

    function startExtraction() {
        if(!rom) return;
        const body = document.getElementById('resBody');
        const pBar = document.getElementById('pBar');
        const start = parseInt(document.getElementById('startOffset').value, 16) || 0x200000;
        body.innerHTML = ""; data = [];
        document.getElementById('pContainer').style.display = "block";
        let i = start;
        function chunk() {
            let limit = Math.min(i + 0x10000, rom.length);
            for(; i<limit; i++) {
                if(rom[i] >= 0xBB && rom[i] <= 0xD4) {
                    let s = "", j = i, clean = true;
                    while(j < rom.length && rom[j] !== 0xFF && s.length < 100) {
                        if(charMap[rom[j]]) s += charMap[rom[j]]; else { clean = false; break; }
                        j++;
                    }
                    if(clean && s.length > 2) {
                        const off = "0x" + i.toString(16).toUpperCase();
                        data.push({o:off, t:s});
                        if(data.length < 500) body.insertAdjacentHTML('beforeend', `<tr><td>${off}</td><td>${s}</td></tr>`);
                        i = j;
                    }
                }
            }
            pBar.style.width = (i/rom.length*100) + "%";
            if(i < rom.length - 1) requestAnimationFrame(chunk);
            else { pBar.style.background = "var(--success)"; alert("Fine!"); }
        }
        chunk();
    }

    function exportToTxt() {
        let txt = "OFFSET | TESTO\n";
        data.forEach(x => txt += `${x.o} | ${x.t}\n`);
        const a = document.createElement('a');
        a.href = URL.createObjectURL(new Blob([txt], {type:'text/plain'}));
        a.download = "traduzione.txt"; a.click();
    }

    async function patchRom() {
        const file = document.getElementById('txtFile').files[0];
        const text = await file.text();
        text.split('\n').forEach(line => {
            if(!line.includes('|')) return;
            const [o, t] = line.split('|').map(s => s.trim());
            const offset = parseInt(o, 16);
            let bytes = [];
            for(let c of t) bytes.push(invMap[c] || 0x00);
            for(let k=0; k<bytes.length; k++) rom[offset+k] = bytes[k];
            rom[offset+bytes.length] = 0xFF;
        });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(new Blob([rom], {type:'application/octet-stream'}));
        a.download = "Pokemon_ITA.gba"; a.click();
    }
</script>
</body>
</html>

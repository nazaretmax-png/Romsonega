<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>DL2 Save Editor</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Syne+Mono&family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg:     #0B0B0B;
  --s1:     #131313;
  --s2:     #1A1A1A;
  --line:   #222;
  --line2:  #2C2C2C;
  --gold:   #C9900A;
  --gold2:  #EAB32A;
  --goldd:  #9A6F06;
  --txt:    #D8D5CE;
  --muted:  #484844;
  --green:  #4EC994;
  --red:    #D95050;
  --blue:   #5899D4;
  --mono:   'Syne Mono', monospace;
  --sans:   'Syne', sans-serif;
  --r:      6px;
}

html { font-size: 15px; }

body {
  background: var(--bg);
  color: var(--txt);
  font-family: var(--sans);
  min-height: 100dvh;
  display: flex;
  flex-direction: column;
  align-items: center;
}

.shell {
  width: 100%;
  max-width: 600px;
  display: flex;
  flex-direction: column;
  min-height: 100dvh;
}

/* â”€â”€ Header â”€â”€â”€ */
header {
  padding: 20px 20px 0;
  display: flex;
  align-items: baseline;
  justify-content: space-between;
}

.logo {
  font-weight: 800;
  font-size: 1.05rem;
  letter-spacing: .08em;
  text-transform: uppercase;
  color: #fff;
}

.logo em { color: var(--gold); font-style: normal; }

.ver {
  font-family: var(--mono);
  font-size: .65rem;
  color: var(--muted);
}

main {
  flex: 1;
  padding: 20px 20px;
  display: flex;
  flex-direction: column;
  gap: 0;
}

/* â”€â”€ Section â”€â”€â”€ */
.sec {
  border-top: 1px solid var(--line);
  padding: 18px 0;
  opacity: 0;
  transform: translateY(6px);
  animation: up .3s forwards;
}
.sec:nth-child(1){animation-delay:.03s}
.sec:nth-child(2){animation-delay:.08s}
.sec:nth-child(3){animation-delay:.13s}

@keyframes up { to { opacity:1; transform:translateY(0); } }

.sec-label {
  font-family: var(--mono);
  font-size: .63rem;
  color: var(--muted);
  letter-spacing: .14em;
  text-transform: uppercase;
  margin-bottom: 14px;
  display: flex;
  align-items: center;
  gap: 8px;
}
.sec-label::after { content:''; flex:1; height:1px; background:var(--line); }

/* â”€â”€ Drop zone â”€â”€â”€ */
.drop {
  border: 1px solid var(--line);
  border-radius: var(--r);
  padding: 26px 20px;
  text-align: center;
  cursor: pointer;
  position: relative;
  background: var(--s1);
  transition: border-color .18s, background .18s;
}
.drop:hover, .drop.drag { border-color: var(--gold); background: var(--s2); }
.drop input { position:absolute; inset:0; opacity:0; width:100%; height:100%; cursor:pointer; }
.drop svg { display:block; margin:0 auto 10px; opacity:.28; }
.drop-title { display:block; font-size:.88rem; font-weight:700; color:var(--txt); }
.drop-sub { display:block; font-family:var(--mono); font-size:.65rem; color:var(--muted); margin-top:3px; }

/* â”€â”€ Status bar after file load â”€â”€â”€ */
.file-bar {
  display: none;
  align-items: center;
  gap: 10px;
  margin-top: 10px;
  background: var(--s2);
  border: 1px solid var(--line);
  border-radius: var(--r);
  padding: 10px 14px;
}
.file-bar.show { display: flex; }
.fb-dot { width:7px; height:7px; border-radius:50%; background:var(--green); box-shadow:0 0 7px var(--green); flex-shrink:0; }
.fb-name { font-family:var(--mono); font-size:.73rem; color:var(--green); flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
.fb-info { font-family:var(--mono); font-size:.63rem; color:var(--muted); flex-shrink:0; }

/* â”€â”€ Editor panel (hidden until file loaded) â”€â”€â”€ */
#editorPanel { display: none; }
#editorPanel.show { display: block; }

/* â”€â”€ Player info strip â”€â”€â”€ */
.player-strip {
  display: flex;
  align-items: center;
  gap: 14px;
  background: var(--s1);
  border: 1px solid var(--line);
  border-radius: var(--r);
  padding: 12px 16px;
  margin-bottom: 14px;
}
.avatar {
  width: 42px; height: 42px;
  border-radius: 50%;
  background: linear-gradient(135deg, #2a2a1a, #1a1a0a);
  border: 1px solid var(--gold);
  display: grid; place-items: center;
  font-size: 1.3rem;
  flex-shrink: 0;
}
.player-name { font-weight: 700; font-size: .95rem; color: #fff; }
.player-meta { font-family: var(--mono); font-size: .63rem; color: var(--muted); margin-top: 2px; }
.player-meta span { color: var(--gold); }

/* â”€â”€ Field groups â”€â”€â”€ */
.group {
  margin-bottom: 16px;
}
.group-title {
  font-family: var(--mono);
  font-size: .62rem;
  color: var(--muted);
  letter-spacing: .12em;
  text-transform: uppercase;
  margin-bottom: 8px;
}

/* â”€â”€ Money card (special) â”€â”€â”€ */
.money-card {
  background: var(--s1);
  border: 1px solid var(--gold);
  border-radius: var(--r);
  padding: 14px 16px;
  margin-bottom: 8px;
  position: relative;
  overflow: hidden;
}
.money-card::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 1px;
  background: linear-gradient(90deg, transparent, var(--gold2), transparent);
  opacity: .4;
}
.money-top {
  display: flex;
  justify-content: space-between;
  align-items: baseline;
  margin-bottom: 10px;
}
.money-label {
  font-family: var(--mono);
  font-size: .62rem;
  color: var(--muted);
  letter-spacing: .1em;
  text-transform: uppercase;
}
.money-current {
  font-family: var(--mono);
  font-size: .75rem;
  color: var(--gold);
}
.money-row {
  display: grid;
  grid-template-columns: 1fr auto;
  gap: 8px;
  align-items: center;
}
.money-input-wrap { position: relative; flex:1; }
.money-input-wrap input {
  background: var(--s2);
  border: 1px solid var(--line2);
  color: #fff;
  border-radius: var(--r);
  padding: 11px 14px;
  font-family: var(--mono);
  font-size: .95rem;
  font-weight: 700;
  width: 100%;
  min-height: 44px;
  transition: border-color .14s;
}
.money-input-wrap input:focus { outline:none; border-color:var(--gold); }
.money-presets {
  display: flex;
  gap: 6px;
  margin-top: 8px;
  flex-wrap: wrap;
}
.preset {
  font-family: var(--mono);
  font-size: .65rem;
  padding: 4px 10px;
  border-radius: 20px;
  border: 1px solid var(--line2);
  background: transparent;
  color: var(--muted);
  cursor: pointer;
  transition: border-color .14s, color .14s;
  min-height: 30px;
}
.preset:hover { border-color: var(--gold); color: var(--gold); }

/* â”€â”€ Stat grid â”€â”€â”€ */
.stat-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 8px;
}
.stat-grid.four { grid-template-columns: repeat(4, 1fr); }

.stat-cell {
  background: var(--s1);
  border: 1px solid var(--line);
  border-radius: var(--r);
  padding: 10px 12px;
  display: flex;
  flex-direction: column;
  gap: 5px;
}
.stat-label {
  font-family: var(--mono);
  font-size: .58rem;
  color: var(--muted);
  letter-spacing: .1em;
  text-transform: uppercase;
}
.stat-cell input, .stat-cell select {
  background: transparent;
  border: none;
  color: #fff;
  font-family: var(--mono);
  font-size: .9rem;
  font-weight: 600;
  width: 100%;
  padding: 0;
  appearance: none;
  -webkit-appearance: none;
  min-height: 24px;
}
.stat-cell input:focus, .stat-cell select:focus { outline: none; color: var(--gold); }
.stat-cell select { cursor: pointer; }

/* â”€â”€ Flat row fields â”€â”€â”€ */
.field-row {
  display: flex;
  align-items: center;
  background: var(--s1);
  border: 1px solid var(--line);
  border-radius: var(--r);
  padding: 11px 14px;
  gap: 12px;
  margin-bottom: 6px;
}
.field-row + .field-row { border-top: none; border-radius: 0; margin-top: -1px; }
.field-row:first-child { border-radius: var(--r) var(--r) 0 0; }
.field-row:last-child  { border-radius: 0 0 var(--r) var(--r); }
.field-row:only-child  { border-radius: var(--r); }
.fr-label {
  font-family: var(--mono);
  font-size: .68rem;
  color: var(--muted);
  flex: 1;
}
.fr-label strong { color: var(--txt); font-weight: 600; display:block; font-size:.78rem; font-family: var(--sans); }
.fr-input {
  background: transparent;
  border: none;
  color: #fff;
  font-family: var(--mono);
  font-size: .85rem;
  font-weight: 600;
  text-align: right;
  width: 90px;
  min-height: 24px;
  padding: 0;
}
.fr-input:focus { outline: none; color: var(--gold); }
.fr-input.wide { width: 130px; }

/* â”€â”€ Action buttons â”€â”€â”€ */
.btn-row { display: flex; gap: 8px; margin-top: 4px; }
.btn {
  flex: 1;
  border: none;
  border-radius: var(--r);
  padding: 13px 14px;
  font-family: var(--sans);
  font-size: .78rem;
  font-weight: 700;
  letter-spacing: .05em;
  text-transform: uppercase;
  cursor: pointer;
  min-height: 48px;
  transition: opacity .14s, transform .1s, background .14s;
}
.btn:active { transform: scale(.97); }
.btn-gold { background: var(--gold); color: #000; }
.btn-gold:hover { background: var(--gold2); }
.btn-ghost {
  background: transparent;
  border: 1px solid var(--line2);
  color: var(--muted);
}
.btn-ghost:hover { border-color: var(--txt); color: var(--txt); }
.btn-dl {
  background: var(--s2);
  border: 1px solid var(--line2);
  color: var(--txt);
}
.btn-dl:hover { border-color: var(--green); color: var(--green); }
.btn-dl:disabled, .btn-gold:disabled { opacity:.3; cursor:not-allowed; transform:none; }

/* â”€â”€ Toast â”€â”€â”€ */
#toast {
  position: fixed;
  bottom: 24px;
  left: 50%;
  transform: translateX(-50%) translateY(80px);
  background: var(--s2);
  border: 1px solid var(--line2);
  border-radius: 30px;
  padding: 10px 20px;
  font-family: var(--mono);
  font-size: .72rem;
  color: var(--txt);
  white-space: nowrap;
  transition: transform .25s ease, opacity .25s;
  opacity: 0;
  z-index: 100;
}
#toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
#toast.ok { border-color: var(--green); color: var(--green); }
#toast.err { border-color: var(--red); color: var(--red); }

/* â”€â”€ Diff badge â”€â”€â”€ */
.diff {
  font-family: var(--mono);
  font-size: .6rem;
  padding: 2px 7px;
  border-radius: 10px;
  background: rgba(78,201,148,.12);
  border: 1px solid rgba(78,201,148,.25);
  color: var(--green);
  display: none;
}
.diff.show { display: inline-block; }

/* â”€â”€ Footer â”€â”€â”€ */
footer {
  padding: 12px 20px max(12px, env(safe-area-inset-bottom));
  border-top: 1px solid var(--line);
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.fstat {
  display: flex; align-items: center; gap: 7px;
  font-family: var(--mono); font-size: .62rem; color: var(--muted);
}
.fdot {
  width: 6px; height: 6px; border-radius: 50%;
  background: var(--muted);
  transition: background .3s, box-shadow .3s;
}
.fdot.on { background: var(--green); box-shadow: 0 0 6px var(--green); }

/* â”€â”€ Loan / Investment cards â”€â”€â”€ */
.fin-card {
  background: var(--s1);
  border: 1px solid var(--line);
  border-radius: var(--r);
  padding: 13px 14px;
  margin-bottom: 7px;
  position: relative;
}
.fin-card.danger { border-color: rgba(217,80,80,.4); }
.fin-card.good   { border-color: rgba(78,201,148,.35); }

.fin-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
}
.fin-title {
  font-family: var(--mono);
  font-size: .7rem;
  color: var(--txt);
  font-weight: 700;
}
.fin-badge {
  font-family: var(--mono);
  font-size: .6rem;
  padding: 2px 8px;
  border-radius: 10px;
}
.fin-badge.red  { background: rgba(217,80,80,.15);  border:1px solid rgba(217,80,80,.35);  color:var(--red); }
.fin-badge.grn  { background: rgba(78,201,148,.12); border:1px solid rgba(78,201,148,.3);  color:var(--green); }
.fin-badge.gld  { background: rgba(201,144,10,.12); border:1px solid rgba(201,144,10,.3);  color:var(--gold); }

.fin-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 7px;
}
.fin-field { display: flex; flex-direction: column; gap: 4px; }
.fin-label {
  font-family: var(--mono);
  font-size: .58rem;
  color: var(--muted);
  letter-spacing: .08em;
  text-transform: uppercase;
}
.fin-input {
  background: var(--s2);
  border: 1px solid var(--line2);
  color: #fff;
  border-radius: 4px;
  padding: 8px 10px;
  font-family: var(--mono);
  font-size: .82rem;
  width: 100%;
  min-height: 38px;
  transition: border-color .14s;
}
.fin-input:focus { outline:none; border-color:var(--gold); }

.fin-actions {
  display: flex;
  gap: 7px;
  margin-top: 9px;
}
.fin-btn {
  flex: 1;
  border: none;
  border-radius: 4px;
  padding: 8px 12px;
  font-family: var(--mono);
  font-size: .65rem;
  font-weight: 700;
  letter-spacing: .05em;
  text-transform: uppercase;
  cursor: pointer;
  min-height: 36px;
  transition: opacity .14s;
}
.fin-btn:active { opacity: .7; }
.fin-btn-del  { background: rgba(217,80,80,.15);  border:1px solid rgba(217,80,80,.4);  color:var(--red); }
.fin-btn-del:hover  { background: rgba(217,80,80,.25); }
.fin-btn-zero { background: rgba(78,201,148,.1);  border:1px solid rgba(78,201,148,.35); color:var(--green); }
.fin-btn-zero:hover { background: rgba(78,201,148,.2); }

.fin-empty {
  font-family: var(--mono);
  font-size: .68rem;
  color: var(--muted);
  text-align: center;
  padding: 14px;
  background: var(--s1);
  border: 1px dashed var(--line2);
  border-radius: var(--r);
}

@media (max-width: 420px) {
  .stat-grid.four { grid-template-columns: repeat(2, 1fr); }
  .btn-row { flex-direction: column; }
  .money-row { grid-template-columns: 1fr; }
  .fin-grid { grid-template-columns: 1fr; }
}
</style>
</head>
<body>
<div class="shell">

<header>
  <span class="logo">DL2 <em>Save</em> Editor</span>
  <span class="ver">v3.6 â€” smart</span>
</header>

<main>

  <!-- STEP 1: CARICA FILE -->
  <div class="sec">
    <div class="sec-label">carica il tuo salvataggio</div>

    <div class="drop" id="drop">
      <input type="file" id="fileInput" accept=".dat,.sav">
      <svg width="32" height="32" viewBox="0 0 32 32" fill="none">
        <rect x="3" y="3" width="26" height="26" rx="3.5" stroke="#D8D5CE" stroke-width="1.4"/>
        <path d="M16 10v12M11 17l5 5 5-5" stroke="#D8D5CE" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      <span class="drop-title">Trascina il file qui, o clicca</span>
      <span class="drop-sub">savegame1.dat Â· .sav Â· Dealer's Life 2</span>
    </div>

    <div class="file-bar" id="fileBar">
      <div class="fb-dot"></div>
      <span class="fb-name" id="fbName">â€”</span>
      <span class="fb-info" id="fbInfo">â€”</span>
    </div>
  </div>

  <!-- STEP 2: EDITOR (mostrato dopo caricamento) -->
  <div class="sec" id="editorPanel">

    <!-- Player strip -->
    <div class="player-strip" id="playerStrip">
      <div class="avatar" id="avatarEl">ğŸ°</div>
      <div>
        <div class="player-name" id="playerName">â€”</div>
        <div class="player-meta">Giorno <span id="metaDay">â€”</span> Â· <select id="metaDiff" oninput="saveData.difficulty=parseInt(this.value);markDirty()" style="background:transparent;border:none;color:var(--gold);font-family:var(--mono);font-size:.63rem;padding:0;cursor:pointer;appearance:none;-webkit-appearance:none"><option value="1">Facile</option><option value="2">Normale</option><option value="3">Difficile</option></select> Â· Rep. <span id="metaRep">â€”</span></div>
      </div>
    </div>

    <!-- SOLDI -->
    <div class="group">
      <div class="group-title">ğŸ’° &nbsp;soldi</div>
      <div class="money-card">
        <div class="money-top">
          <span class="money-label">Saldo corrente</span>
          <span class="money-current" id="moneyDisplay">â€”</span>
        </div>
        <div id="cashBreakdown" style="font-family:var(--mono);font-size:.62rem;color:var(--muted);margin-bottom:10px;line-height:1.7;padding:8px 10px;background:var(--bg);border-radius:4px;border:1px solid var(--line)"></div>
        <div class="money-row">
          <div class="money-input-wrap">
            <input type="number" id="cashInput" placeholder="Nuovo importo" min="0" step="1"
                   oninput="onCashInput()">
          </div>
        </div>
        <div class="money-presets">
          <button class="preset" onclick="setPreset(10000)">10.000</button>
          <button class="preset" onclick="setPreset(50000)">50.000</button>
          <button class="preset" onclick="setPreset(100000)">100.000</button>
          <button class="preset" onclick="setPreset(500000)">500.000</button>
          <button class="preset" onclick="setPreset(1000000)">1.000.000</button>
        </div>
      </div>
    </div>

    <!-- STATISTICHE GIOCATORE -->
    <div class="group">
      <div class="group-title">ğŸ§  &nbsp;abilitÃ  giocatore</div>
      <div class="stat-grid four">
        <div class="stat-cell">
          <span class="stat-label">Carisma</span>
          <input type="number" id="statCharisma" min="0" max="8" oninput="markDirty()">
        </div>
        <div class="stat-cell">
          <span class="stat-label">Competenza</span>
          <input type="number" id="statCompetence" min="0" max="8" oninput="markDirty()">
        </div>
        <div class="stat-cell">
          <span class="stat-label">Intuito</span>
          <input type="number" id="statInsight" min="0" max="8" oninput="markDirty()">
        </div>
        <div class="stat-cell">
          <span class="stat-label">Fortuna</span>
          <input type="number" id="statLuck" min="0" max="8" oninput="markDirty()">
        </div>
      </div>
    </div>

    <!-- NEGOZIO & ALTRO -->
    <div class="group">
      <div class="group-title">ğŸª &nbsp;negozio e gioco</div>
      <div class="field-row">
        <div class="fr-label"><strong>Reputazione</strong>fame points â€” scala fama negozio</div>
        <input class="fr-input" type="number" id="statRep" min="0" oninput="markDirty()">
      </div>
      <div class="field-row">
        <div class="fr-label"><strong>Cariche Expert</strong>perizie disponibili</div>
        <input class="fr-input" type="number" id="statExpert" min="0" oninput="markDirty()">
      </div>
      <div class="field-row">
        <div class="fr-label"><strong>Cariche Brainwasher</strong>utilizzi disponibili</div>
        <input class="fr-input" type="number" id="statBrain" min="0" oninput="markDirty()">
      </div>
      <div class="field-row">
        <div class="fr-label"><strong>Slot Dipendenti</strong>max personale reclutabile</div>
        <input class="fr-input" type="number" id="statEmpSlots" min="1" max="99" oninput="markDirty()">
      </div>
      <div class="field-row">
        <div class="fr-label"><strong>Slot Inventario</strong>oggetti max nel negozio</div>
        <input class="fr-input" type="number" id="statInvSlots" min="1" max="99" oninput="markDirty()">
      </div>
      <div class="field-row">
        <div class="fr-label"><strong>Slot Clienti</strong>clienti max simultanei</div>
        <input class="fr-input" type="number" id="statCustSlots" min="1" max="99" oninput="markDirty()">
      </div>
        <input class="fr-input wide" type="number" id="statRent" min="0" oninput="markDirty()">
      </div>
      <div class="field-row">
        <div class="fr-label"><strong>Costo settimanale</strong>stipendi + spese fisse</div>
        <input class="fr-input wide" type="number" id="statWeekly" min="0" oninput="markDirty()">
      </div>
      <div class="field-row">
        <div class="fr-label"><strong>Giorno corrente</strong>avanza nel calendario</div>
        <input class="fr-input" type="number" id="statDay" min="1" oninput="markDirty()">
      </div>
    </div>

    <!-- PRESTITI -->
    <div class="group">
      <div class="group-title">ğŸ¦ &nbsp;prestiti</div>
      <div id="loansContainer">
        <div class="fin-empty">Nessun prestito attivo</div>
      </div>
    </div>

    <!-- INVESTIMENTI -->
    <div class="group">
      <div class="group-title">ğŸ“ˆ &nbsp;investimenti</div>
      <div id="investContainer">
        <div class="fin-empty">Nessun investimento attivo</div>
      </div>
    </div>

    <!-- PULSANTI -->
    <div class="btn-row">
      <button class="btn btn-gold" id="btnApply" onclick="applyChanges()">
        âœ“ &nbsp;Applica e Scarica
      </button>
      <button class="btn btn-ghost" onclick="resetEditor()">
        Annulla
      </button>
    </div>
    <div class="btn-row" style="margin-top:8px">
      <button class="btn btn-dl" id="btnBak" onclick="downloadBackup()">
        â†“ &nbsp;Scarica .bak manuale
      </button>
    </div>
    <p style="font-family:var(--mono);font-size:.6rem;color:var(--muted);margin-top:8px;line-height:1.6;padding:0 2px">
      â„¹ Il gioco crea giÃ  il .bak automaticamente ad ogni salvataggio â€” non Ã¨ necessario scaricarlo dall'editor.
    </p>

  </div>

</main>

<footer>
  <div class="fstat">
    <div class="fdot" id="fdot"></div>
    <span id="fst">NESSUN FILE</span>
  </div>
  <span style="font-family:var(--mono);font-size:.58rem;color:var(--muted);opacity:.4">DEALER'S LIFE 2</span>
</footer>

</div>

<div id="toast"></div>

<script>
const XOR_KEY = 0x7B;   // chiave XOR di Dealer's Life 2 â€” rilevata automaticamente

let rawBytes = null;    // Uint8Array originale (cifrato)
let saveData = null;    // oggetto JSON parsato
let fileName = '';

/* â”€â”€â”€ File load â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const drop = document.getElementById('drop');
drop.addEventListener('dragover',  e => { e.preventDefault(); drop.classList.add('drag'); });
drop.addEventListener('dragleave', () => drop.classList.remove('drag'));
drop.addEventListener('drop', e => {
  e.preventDefault(); drop.classList.remove('drag');
  const f = e.dataTransfer.files[0]; if (f) loadFile(f);
});
document.getElementById('fileInput').onchange = e => {
  const f = e.target.files[0]; if (f) loadFile(f);
};

function loadFile(file) {
  fileName = file.name;
  const reader = new FileReader();
  reader.onload = ev => {
    rawBytes = new Uint8Array(ev.target.result);
    try {
      const json = decodeXOR(rawBytes);
      saveData = JSON.parse(json);
    } catch (err) {
      toast('âŒ File non riconosciuto o formato errato', 'err');
      return;
    }
    // aggiorna UI
    document.getElementById('fileBar').classList.add('show');
    document.getElementById('fbName').textContent = fileName;
    document.getElementById('fbInfo').textContent = fmtBytes(rawBytes.length) + ' Â· JSON+XOR 0x7B';
    setStatus(fmtBytes(rawBytes.length), true);
    populateEditor();
    document.getElementById('editorPanel').classList.add('show');
    toast('âœ“ File caricato correttamente', 'ok');
  };
  reader.readAsArrayBuffer(file);
}

/* â”€â”€â”€ Decode / Encode â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function decodeXOR(buf) {
  return new TextDecoder().decode(buf.map(b => b ^ XOR_KEY));
}

function encodeXOR(jsonStr) {
  const bytes = new TextEncoder().encode(jsonStr);
  return bytes.map(b => b ^ XOR_KEY);
}

/* â”€â”€â”€ Popola editor â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function populateEditor() {
  const d    = saveData;
  const p    = d.player;
  const rawVal  = d.cash.value;
  const offset  = d.cash.offset;
  const cash    = rawVal + offset;

  // Player strip
  const avatars = ['ğŸ°','ğŸƒ','ğŸ’¼','ğŸ§³','ğŸ’','ğŸª™','ğŸ†','ğŸ©'];
  document.getElementById('avatarEl').textContent   = avatars[p.avatarId] || 'ğŸ°';
  document.getElementById('playerName').textContent = p.nickname || 'Giocatore';
  document.getElementById('metaDay').textContent    = d.day;
  document.getElementById('metaDiff').value         = d.difficulty ?? 1;
  document.getElementById('metaRep').textContent    = p.reputation;

  // Nota cash breakdown
  const sign = offset >= 0 ? '+' : '';
  const noteEl = document.getElementById('cashBreakdown');
  noteEl.innerHTML =
    `valore base: <span style="color:var(--txt)">${fmtMoney(rawVal)}</span> &nbsp;` +
    `offset: <span style="color:${offset < 0 ? 'var(--red)' : 'var(--green)'}">${sign}${fmtMoney(offset)}</span><br>` +
    `saldo file: <span style="color:var(--gold)">${fmtMoney(cash)}</span> &nbsp;` +
    `<span style="opacity:.6">â€” il gioco puÃ² mostrare Â±qualche centinaio per transazioni non ancora salvate</span>`;

  // Soldi
  document.getElementById('moneyDisplay').textContent = fmtMoney(cash);
  document.getElementById('cashInput').value = cash;

  // AbilitÃ 
  document.getElementById('statCharisma').value   = p.charisma;
  document.getElementById('statCompetence').value = p.competence;
  document.getElementById('statInsight').value    = p.insight;
  document.getElementById('statLuck').value       = p.luck;

  // Negozio e altro
  document.getElementById('statRep').value    = p.reputation;
  document.getElementById('statExpert').value = d.shop.expertCharges;
  document.getElementById('statBrain').value  = d.shop.brainwasherCharges;
  document.getElementById('statEmpSlots').value  = d.shop.baseShop.employeeSlots;
  document.getElementById('statInvSlots').value  = d.shop.baseShop.inventorySlots;
  document.getElementById('statCustSlots').value = d.shop.baseShop.customerSlots;
  document.getElementById('statRent').value   = d.shop.baseShop.rentCost;
  document.getElementById('statWeekly').value = d.shop.baseShop.weeklyCost;
  document.getElementById('statDay').value    = d.day;

  // Prestiti e investimenti
  renderLoans();
  renderInvestments();
}

/* â”€â”€â”€ Preset soldi â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function setPreset(v) {
  document.getElementById('cashInput').value = v;
  onCashInput();
}

function onCashInput() {
  markDirty();
}

/* â”€â”€â”€ Dirty marker â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function markDirty() { /* salva tutto al click Applica */ }

/* â”€â”€â”€ Render Prestiti â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function renderLoans() {
  const loans = saveData.loans || [];
  const el = document.getElementById('loansContainer');
  if (!loans.length) {
    el.innerHTML = '<div class="fin-empty">Nessun prestito attivo</div>';
    return;
  }
  el.innerHTML = loans.map((l, i) => {
    const total    = l.value + l.interests;
    const endDay   = l.startDay + l.durationInWeeks * 7;
    const daysLeft = Math.max(0, endDay - (saveData.day || 0));
    const weekly   = Math.round(total / l.durationInWeeks);
    return `
    <div class="fin-card danger">
      <div class="fin-header">
        <span class="fin-title">Prestito #${i+1}</span>
        <span class="fin-badge red">${daysLeft} giorni rimasti</span>
      </div>
      <div class="fin-grid">
        <div class="fin-field">
          <span class="fin-label">Capitale</span>
          <input class="fin-input" type="number" id="loan_val_${i}" value="${l.value}" min="0" oninput="markDirty()">
        </div>
        <div class="fin-field">
          <span class="fin-label">Interessi (${Math.round(l.interests/l.value*100)}%)</span>
          <input class="fin-input" type="number" id="loan_int_${i}" value="${l.interests}" min="0" oninput="markDirty()">
        </div>
        <div class="fin-field">
          <span class="fin-label">Durata (settimane)</span>
          <input class="fin-input" type="number" id="loan_dur_${i}" value="${l.durationInWeeks}" min="1" oninput="markDirty()">
        </div>
        <div class="fin-field">
          <span class="fin-label">Giorno inizio</span>
          <input class="fin-input" type="number" id="loan_start_${i}" value="${l.startDay}" min="1" oninput="markDirty()">
        </div>
      </div>
      <div style="font-family:var(--mono);font-size:.62rem;color:var(--muted);margin-top:8px">
        Totale da restituire: <span style="color:var(--red)">${fmtMoney(total)}</span> &nbsp;Â·&nbsp;
        Rata settimanale: <span style="color:var(--gold)">${fmtMoney(weekly)}</span>
      </div>
      <div class="fin-actions">
        <button class="fin-btn fin-btn-zero" onclick="cancelLoan(${i})">âœ“ Estingui subito</button>
        <button class="fin-btn fin-btn-del"  onclick="deleteLoan(${i})">âœ• Elimina</button>
      </div>
    </div>`;
  }).join('');
}

function cancelLoan(i) {
  // Azzera gli interessi e imposta durata minima â†’ il prestito risulta giÃ  pagato
  saveData.loans[i].interests = 0;
  saveData.loans[i].value     = 0;
  saveData.loans[i].durationInWeeks = 1;
  saveData.loans[i].startDay  = saveData.day - 7;
  renderLoans();
  toast('Prestito estinto â€” il gioco lo rimuoverÃ  al prossimo giorno', 'ok');
}

function deleteLoan(i) {
  saveData.loans.splice(i, 1);
  renderLoans();
  toast('Prestito rimosso dal save', 'ok');
}

/* â”€â”€â”€ Render Investimenti â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function renderInvestments() {
  const invs = saveData.investments || [];
  const el = document.getElementById('investContainer');
  if (!invs.length) {
    el.innerHTML = '<div class="fin-empty">Nessun investimento attivo</div>';
    return;
  }
  // risk: 1=Basso, 2=Medio, 3=Alto
  const riskLabel = { 1:'Basso Rischio', 2:'Medio Rischio', 3:'Alto Rischio' };
  const riskClass = { 1:'grn', 2:'gld', 3:'red' };
  el.innerHTML = invs.map((inv, i) => {
    const endDay   = inv.startDay + inv.durationInWeeks * 7;
    const daysLeft = Math.max(0, endDay - (saveData.day || 0));
    const rc = riskClass[inv.risk] || 'gld';
    const rl = riskLabel[inv.risk] || `Rischio ${inv.risk}`;
    // rendimento stimato: Basso ~10%, Medio ~25%, Alto ~50% (stime, il gioco Ã¨ random)
    const estPct  = { 1: 10, 2: 25, 3: 50 }[inv.risk] || 0;
    const estGain = Math.round(inv.value * estPct / 100);
    return `
    <div class="fin-card good">
      <div class="fin-header">
        <span class="fin-title">Investimento #${i+1}</span>
        <span class="fin-badge ${rc}">${rl}</span>
      </div>
      <div class="fin-grid">
        <div class="fin-field">
          <span class="fin-label">Importo investito</span>
          <input class="fin-input" type="number" id="inv_val_${i}"
            value="${inv.value}" min="0" oninput="markDirty()">
        </div>
        <div class="fin-field">
          <span class="fin-label">Durata (settimane)</span>
          <input class="fin-input" type="number" id="inv_dur_${i}"
            value="${inv.durationInWeeks}" min="1" oninput="markDirty()">
        </div>
        <div class="fin-field">
          <span class="fin-label">Giorno inizio</span>
          <input class="fin-input" type="number" id="inv_start_${i}"
            value="${inv.startDay}" min="1" oninput="markDirty()">
        </div>
        <div class="fin-field">
          <span class="fin-label">Giorni rimasti</span>
          <input class="fin-input" type="text" value="${daysLeft}" readonly
            style="color:var(--muted);cursor:default">
        </div>
      </div>
      <div style="font-family:var(--mono);font-size:.62rem;color:var(--muted);margin-top:8px">
        Scade giorno <span style="color:var(--txt)">${endDay}</span> &nbsp;Â·&nbsp;
        Guadagno stimato: <span style="color:var(--green)">~+${fmtMoney(estGain)}</span>
        <span style="opacity:.5">(stima, il gioco calcola il valore esatto)</span>
      </div>
      <div class="fin-actions">
        <button class="fin-btn fin-btn-zero" onclick="collectInvestment(${i})">ğŸ’° Incassa subito</button>
        <button class="fin-btn fin-btn-del"  onclick="deleteInvestment(${i})">âœ• Elimina</button>
      </div>
    </div>`;
  }).join('');
}

function collectInvestment(i) {
  // Sposta startDay indietro cosÃ¬ durationInWeeks Ã¨ giÃ  scaduta â†’ il gioco incassa al prossimo giorno
  const dur = saveData.investments[i].durationInWeeks;
  saveData.investments[i].startDay = (saveData.day || 0) - dur * 7 - 1;
  renderInvestments();
  toast('Investimento: scaduto retroattivamente â€” incassi al prossimo avvio giorno', 'ok');
}

function deleteInvestment(i) {
  saveData.investments.splice(i, 1);
  renderInvestments();
  toast('Investimento rimosso dal save', 'ok');
}

/* â”€â”€â”€ Applica e scarica â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function applyChanges() {
  if (!saveData) return;

  const d = saveData;
  const p = d.player;

  // Soldi: aggiusta .value, azzera .offset
  const newCash = parseInt(document.getElementById('cashInput').value) || 0;
  d.cash.value  = newCash;
  d.cash.offset = 0;

  // AbilitÃ 
  p.charisma   = clamp(parseInt(document.getElementById("statCharisma").value) || 0, 0, 8);
  p.competence = clamp(parseInt(document.getElementById("statCompetence").value) || 0, 0, 8);
  p.insight    = clamp(parseInt(document.getElementById("statInsight").value) || 0, 0, 8);
  p.luck       = clamp(parseInt(document.getElementById("statLuck").value) || 0, 0, 8);

  // Negozio e altro
  p.reputation = parseInt(document.getElementById('statRep').value)    || 0;
  d.shop.expertCharges          = parseInt(document.getElementById('statExpert').value)  || 0;
  d.shop.brainwasherCharges     = parseInt(document.getElementById('statBrain').value)   || 0;
  d.shop.baseShop.employeeSlots = parseInt(document.getElementById('statEmpSlots').value)  || d.shop.baseShop.employeeSlots;
  d.shop.baseShop.inventorySlots= parseInt(document.getElementById('statInvSlots').value)  || d.shop.baseShop.inventorySlots;
  d.shop.baseShop.customerSlots = parseInt(document.getElementById('statCustSlots').value) || d.shop.baseShop.customerSlots;
  d.shop.baseShop.rentCost      = parseInt(document.getElementById('statRent').value)    || d.shop.baseShop.rentCost;
  d.shop.baseShop.weeklyCost    = parseInt(document.getElementById('statWeekly').value)  || d.shop.baseShop.weeklyCost;
  d.day = parseInt(document.getElementById('statDay').value) || d.day;

  // Leggi campi prestiti modificati manualmente
  (d.loans || []).forEach((l, i) => {
    l.value          = parseInt(document.getElementById(`loan_val_${i}`)?.value)   ?? l.value;
    l.interests      = parseInt(document.getElementById(`loan_int_${i}`)?.value)   ?? l.interests;
    l.durationInWeeks= parseInt(document.getElementById(`loan_dur_${i}`)?.value)   ?? l.durationInWeeks;
    l.startDay       = parseInt(document.getElementById(`loan_start_${i}`)?.value) ?? l.startDay;
  });

  // Leggi campi investimenti modificati manualmente
  (d.investments || []).forEach((inv, i) => {
    inv.value          = parseInt(document.getElementById(`inv_val_${i}`)?.value)   ?? inv.value;
    inv.durationInWeeks= parseInt(document.getElementById(`inv_dur_${i}`)?.value)   ?? inv.durationInWeeks;
    inv.startDay       = parseInt(document.getElementById(`inv_start_${i}`)?.value) ?? inv.startDay;
  });

  // Serializza e cifra
  const json    = JSON.stringify(d);
  const encoded = encodeXOR(json);

  // Download file modificato â€” stesso nome originale per sostituzione diretta
  dlBuffer(encoded, fileName);
  toast('âœ“ "' + fileName + '" pronto â€” sostituisci direttamente!', 'ok');

  // Aggiorna display soldi
  document.getElementById('moneyDisplay').textContent = fmtMoney(newCash);
  document.getElementById('metaRep').textContent = p.reputation;
  document.getElementById('metaDay').textContent = d.day;
}

/* â”€â”€â”€ Download backup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function downloadBackup() {
  if (!rawBytes) return;
  dlBuffer(rawBytes, fileName + '.bak');
  toast('Backup .bak scaricato', 'ok');
}

/* â”€â”€â”€ Reset â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function resetEditor() {
  if (!saveData) return;
  populateEditor();
  toast('Modifiche annullate', '');
}

/* â”€â”€â”€ Utils â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function dlBuffer(data, name) {
  const url = URL.createObjectURL(new Blob([data], { type: 'application/octet-stream' }));
  const a = Object.assign(document.createElement('a'), { href: url, download: name });
  a.click();
  setTimeout(() => URL.revokeObjectURL(url), 1000);
}

function fmtMoney(n) {
  return n.toLocaleString('it-IT') + ' â‚¬';
}

function fmtBytes(n) {
  if (n < 1024) return n + ' B';
  if (n < 1048576) return (n / 1024).toFixed(1) + ' KB';
  return (n / 1048576).toFixed(2) + ' MB';
}

function clamp(v, min, max) { return Math.min(Math.max(v, min), max); }

function setStatus(txt, on) {
  document.getElementById('fst').textContent = txt;
  document.getElementById('fdot').classList.toggle('on', on);
}

let toastTimer;
function toast(msg, type) {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.className = 'show ' + (type || '');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => el.className = '', 3000);
}
</script>
</body>
</html>

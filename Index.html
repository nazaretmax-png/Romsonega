<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>GBA Multi-Pok√©mon Translator</title>
    <style>
        :root { --bg: #0a0f1e; --card: #161e31; --accent: #6366f1; --success: #10b981; --text: #f1f5f9; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); padding: 20px; max-width: 1100px; margin: 0 auto; }
        .card { background: var(--card); padding: 20px; border-radius: 12px; border: 1px solid #2d3748; margin-bottom: 20px; }
        .grid { display: grid; grid-template-columns: 350px 1fr; gap: 20px; }
        .detected-badge { display: inline-block; padding: 5px 12px; border-radius: 20px; background: var(--accent); font-weight: bold; font-size: 14px; margin-top: 10px; }
        button { background: var(--accent); color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; width: 100%; font-weight: bold; margin-top: 10px; transition: 0.2s; }
        button:hover { filter: brightness(1.2); }
        .preview-area { background: #000; border-radius: 8px; height: 500px; overflow-y: auto; border: 1px solid #2d3748; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th { background: #1a202c; position: sticky; top: 0; padding: 12px; text-align: left; color: var(--accent); border-bottom: 2px solid #2d3748; }
        td { padding: 10px; border-bottom: 1px solid #1a202c; }
        .offset { color: #818cf8; font-family: monospace; }
        input[type="file"] { width: 100%; padding: 10px; background: #0a0f1e; border: 1px dashed #4a5568; color: white; border-radius: 6px; }
    </style>
</head>
<body>

    <h1>Pok√©mon GBA Universal Translator üåå</h1>

    <div class="grid">
        <div class="sidebar">
            <div class="card">
                <h3>1. Carica la ROM</h3>
                <input type="file" id="romFile" accept=".gba">
                <div id="gameBadge" class="detected-badge" style="display:none;"></div>
            </div>

            <div class="card">
                <h3>2. Filtri Traduzione</h3>
                <p style="font-size:12px; opacity:0.8;">Scegli cosa estrarre:</p>
                <select id="categorySelect" style="width:100%; padding:10px; background:#000; color:white; border-radius:5px;">
                    <option value="MOVES">‚öîÔ∏è Mosse (Moves)</option>
                    <option value="ITEMS">üéí Oggetti (Items)</option>
                    <option value="ABILITIES">üß¨ Abilit√† (Abilities)</option>
                    <option value="DIALOGS">üí¨ Dialoghi (Script)</option>
                </select>
                <button onclick="scan()">Scansiona ROM</button>
                <button onclick="downloadTxt()" style="background: #3b82f6;">Esporta per Traduzione</button>
            </div>

            <div class="card">
                <h3>3. Importa Patch</h3>
                <input type="file" id="importFile" accept=".txt">
                <button onclick="importAndSave()" style="background: var(--success);">Applica e Salva ROM</button>
            </div>
        </div>

        <div class="main">
            <div class="card">
                <h3>Anteprima Dati</h3>
                <div class="preview-area">
                    <table>
                        <thead>
                            <tr><th>Offset</th><th>Testo</th></tr>
                        </thead>
                        <tbody id="resBody">
                            <tr><td colspan="2" style="text-align:center; padding:20px;">In attesa della ROM...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

<script>
    // Database Offset Pok√©mon GBA (Versioni USA/Inglesi)
    const GAME_DB = {
        "BPRE": { name: "FireRed (USA)", moves: 0x247094, items: 0x3DB028, abilities: 0x24F2AC, dialogs: 0x400000 },
        "BPGE": { name: "LeafGreen (USA)", moves: 0x247094, items: 0x3DB028, abilities: 0x24F2AC, dialogs: 0x400000 },
        "BPEE": { name: "Emerald (USA)", moves: 0x31977C, items: 0x5839A0, abilities: 0x31C420, dialogs: 0x500000 },
        "AXVE": { name: "Ruby (USA)", moves: 0x1F8320, items: 0x3D4294, abilities: 0x1F995C, dialogs: 0x300000 },
        "AXPE": { name: "Sapphire (USA)", moves: 0x1F8320, items: 0x3D4294, abilities: 0x1F995C, dialogs: 0x300000 }
    };

    const charMap = { 0x00: ' ', 0x01: '√Ä', 0x02: '√Å', 0x03: '√Ç', 0x04: '√á', 0x05: '√à', 0x06: '√â', 0x07: '√ä', 0x08: '√ã', 0x09: '√å', 0x0B: '√é', 0x0C: '√è', 0x0D: '√í', 0x0E: '√ì', 0x0F: '√î', 0x10: '≈í', 0x11: '√ô', 0x12: '√ö', 0x13: '√õ', 0x14: '≈∏', 0x15: '√ü', 0x16: '√†', 0x17: '√°', 0x19: '√ß', 0x1A: '√®', 0x1B: '√©', 0x1C: '√™', 0x1D: '√´', 0x1E: '√¨', 0x20: '√Æ', 0x21: '√Ø', 0x22: '√≤', 0x23: '√≥', 0x24: '√¥', 0x25: '≈ì', 0x26: '√π', 0x27: '√∫', 0x28: '√ª', 0x29: '√ø', 0x2D: '&', 0x2E: '+', 0xAB: '!', 0xAC: '?', 0xAD: '.', 0xAE: '-', 0xB0: '...', 0xB8: ',', 0xBB: 'A', 0xBC: 'B', 0xBD: 'C', 0xBE: 'D', 0xBF: 'E', 0xC0: 'F', 0xC1: 'G', 0xC2: 'H', 0xC3: 'I', 0xC4: 'J', 0xC5: 'K', 0xC6: 'L', 0xC7: 'M', 0xC8: 'N', 0xC9: 'O', 0xCA: 'P', 0xCB: 'Q', 0xCC: 'R', 0xCD: 'S', 0xCE: 'T', 0xCF: 'U', 0xD0: 'V', 0xD1: 'W', 0xD2: 'X', 0xD3: 'Y', 0xD4: 'Z', 0xD5: 'a', 0xD6: 'b', 0xD7: 'c', 0xD8: 'd', 0xD9: 'e', 0xDA: 'f', 0xDB: 'g', 0xDC: 'h', 0xDD: 'i', 0xDE: 'j', 0xDF: 'k', 0xE0: 'l', 0xE1: 'm', 0xE2: 'n', 0xE3: 'o', 0xE4: 'p', 0xE5: 'q', 0xE6: 'r', 0xE7: 's', 0xE8: 't', 0xE9: 'u', 0xEA: 'v', 0xEB: 'w', 0xEC: 'x', 0xED: 'y', 0xEE: 'z', 0xFE: '[NL]', 0xFF: '[END]' };
    const invMap = Object.fromEntries(Object.entries(charMap).map(([k, v]) => [v, parseInt(k)]));

    let rom = null;
    let detectedGame = null;
    let foundItems = [];

    document.getElementById('romFile').onchange = function(e) {
        const reader = new FileReader();
        reader.onload = () => {
            rom = new Uint8Array(reader.result);
            // Auto-detect Game ID at 0xAC
            let id = "";
            for(let i=0xAC; i<0xB0; i++) id += String.fromCharCode(rom[i]);
            
            const badge = document.getElementById('gameBadge');
            if(GAME_DB[id]) {
                detectedGame = GAME_DB[id];
                badge.innerText = "Gioco Rilevato: " + detectedGame.name;
                badge.style.display = "block";
                badge.style.background = "#10b981";
            } else {
                detectedGame = null;
                badge.innerText = "Gioco Sconosciuto (ID: "+id+") - Scansione Manuale";
                badge.style.display = "block";
                badge.style.background = "#ef4444";
            }
        };
        reader.readAsArrayBuffer(this.files[0]);
    };

    function scan() {
        if(!rom) return alert("Carica la ROM!");
        const cat = document.getElementById('categorySelect').value;
        const body = document.getElementById('resBody');
        body.innerHTML = ""; foundItems = [];
        
        let startOffset = (detectedGame) ? detectedGame[cat.toLowerCase()] : 0x100000;
        
        for(let i = startOffset; i < rom.length - 15; i++) {
            if(rom[i] >= 0xBB && rom[i] <= 0xD4) {
                let s = ""; let j = i;
                while(j < rom.length && rom[j] !== 0xFF && s.length < 500) {
                    s += charMap[rom[j]] || ''; j++;
                }
                // Filtro: se la stringa ha senso (almeno 3 car.)
                if(s.length >= 3) {
                    const off = "0x" + i.toString(16).toUpperCase();
                    foundItems.push({o: off, t: s});
                    body.innerHTML += `<tr><td class="offset">${off}</td><td>${s}</td></tr>`;
                    i = j;
                }
            }
            if(foundItems.length > 500) break; // Limite visivo anteprima
        }
    }

    function downloadTxt() {
        if(foundItems.length === 0) return alert("Scansiona prima!");
        let txt = "ID_ROM: " + (detectedGame ? detectedGame.name : "Unknown") + "\n";
        txt += "OFFSET | TESTO_ORIGINALE\n";
        foundItems.forEach(item => { txt += `${item.o} | ${item.t}\n`; });
        const blob = new Blob([txt], {type:'text/plain'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = "traduzione_gba.txt";
        a.click();
    }

    async function importAndSave() {
        const file = document.getElementById('importFile').files[0];
        if(!file || !rom) return alert("Carica i file!");
        const text = await file.text();
        const lines = text.split('\n');
        
        lines.forEach(line => {
            if(!line.includes('|')) return;
            const [offStr, content] = line.split('|').map(s => s.trim());
            const offset = parseInt(offStr, 16);
            
            // Trova lunghezza originale per non sforare
            let maxLen = 0;
            while(rom[offset + maxLen] !== 0xFF) maxLen++;
            
            let bytes = [];
            for(let char of content) bytes.push(invMap[char] || 0x00);
            bytes.push(0xFF);

            for(let i=0; i <= maxLen; i++) {
                rom[offset + i] = (i < bytes.length) ? bytes[i] : 0x00;
            }
        });
        
        const blob = new Blob([rom], {type:'application/octet-stream'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = "ROM_MODIFICATA.gba";
        a.click();
        alert("ROM Salvata!");
    }
</script>
</body>
</html>
